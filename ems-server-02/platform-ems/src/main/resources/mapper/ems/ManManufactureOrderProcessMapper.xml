<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.platform.ems.mapper.ManManufactureOrderProcessMapper">
    <resultMap type="com.platform.ems.domain.ManManufactureOrderProcess" id="ManManufactureOrderProcessResult">
        <result property="clientId" column="client_id"/>
        <result property="manufactureOrderProcessSid" column="manufacture_order_process_sid"/>
        <result property="manufactureOrderSid" column="manufacture_order_sid"/>
        <result property="manufactureOrderCode" column="manufacture_order_code"/>
        <result property="processSid" column="process_sid"/>
        <result property="processName" column="process_name"/>
        <result property="workCenterSid" column="work_center_sid"/>
        <result property="serialNum" column="serial_num"/>
        <result property="startFlag" column="start_flag"/>
        <result property="endFlag" column="end_flag"/>
        <result property="processBatchNum" column="process_batch_num"/>
        <result property="picturePath" column="picture_path"/>
        <result property="videoPath" column="video_path"/>
        <result property="endStatus" column="end_status"/>
        <result property="currentCompleteQuantity" column="current_complete_quantity"/>
        <result property="quantity" column="quantity"/>
        <result property="comment" column="comment"/>
        <result property="cancelFlag" column="cancel_flag"/>
        <result property="planStartDate" column="plan_start_date"/>
        <result property="actualStartDate" column="actual_start_date"/>
        <result property="planEndDate" column="plan_end_date"/>
        <result property="initialPlanEndDate" column="initial_plan_end_date"/>
        <result property="actualEndDate" column="actual_end_date"/>
        <result property="productionMode" column="production_mode"/>
        <result property="isStageComplete" column="is_stage_complete"/>
        <result property="isProduceComplete" column="is_produce_complete"/>
        <result property="isFirstProcess" column="is_first_process"/>
        <result property="itemNum" column="item_num"/>
        <result property="quantityReferProcessSid" column="quantity_refer_process_sid"/>
        <result property="quantityReferProcessCode" column="quantity_refer_process_code"/>
        <result property="quantityReferProcessName" column="quantity_refer_process_name"/>
        <result property="quantityTypeReferProcess" column="quantity_type_refer_process"/>
        <result property="directorSid" column="director_sid"/>
        <result property="directorCode" column="director_code"/>
        <result property="isProduceTg" column="is_produce_tg"/>
        <result property="planStartDateTg" column="plan_start_date_tg"/>
        <result property="actualEndDateTg" column="actual_end_date_tg"/>
        <result property="isProduceSp" column="is_produce_sp"/>
        <result property="planStartDateSp" column="plan_start_date_sp"/>
        <result property="actualEndDateSp" column="actual_end_date_sp"/>
        <result property="departmentSid" column="department_sid"/>
        <result property="departmentCode" column="department_code"/>
        <result property="departmentName" column="department_name"/>
        <result property="milestone" column="milestone"/>
        <result property="remark" column="remark"/>
        <result property="creatorAccount" column="creator_account"/>
        <result property="createDate" column="create_date"/>
        <result property="updaterAccount" column="updater_account"/>
        <result property="updateDate" column="update_date"/>
        <result property="dataSourceSys" column="data_source_sys"/>
        <result property="salesOrderSid" column="sales_order_sid"/>
        <result property="salesOrderCode" column="sales_order_code"/>
        <result property="customerSid" column="customer_sid"/>
        <result property="customerCode" column="customer_code"/>
        <result property="customerName" column="customer_name"/>
        <result property="plantSid" column="plant_sid"/>
        <result property="plantCode" column="plant_code"/>
        <result property="plantName" column="plant_name"/>
        <result property="plantShortName" column="plant_short_name"/>
        <result property="materialSid" column="material_sid"/>
        <result property="materialName" column="material_name"/>
        <result property="materialCode" column="material_code"/>
        <result property="sku1Sid" column="sku1_sid"/>
        <result property="sku1Name" column="sku1_name"/>
        <result property="sku2Sid" column="sku2_sid"/>
        <result property="sku2Name" column="sku2_name"/>
        <result property="processCode" column="process_code"/>
        <result property="processName" column="process_name"/>
        <result property="workCenterCode" column="work_center_code"/>
        <result property="workCenterName" column="work_center_name"/>
        <result property="barcodeSid" column="barcode_sid"/>
        <result property="barcode" column="barcode"/>
        <result property="unitBase" column="unit_base"/>
        <result property="unitBaseName" column="unit_base_name"/>
        <result property="companySid" column="company_sid"/>
        <result property="creatorAccountName" column="creator_account_name"/>
        <result property="updaterAccountName" column="updater_account_name"/>
        <result property="directorName" column="director_name"/>
        <result property="orderPlantSid" column="order_plant_sid"/>
    </resultMap>

    <sql id="selectManManufactureOrderProcessVo">
        SELECT
            t.client_id,
            t.manufacture_order_process_sid,
            t.manufacture_order_sid,
            t.process_sid,
            t.process_name,
            t.work_center_sid,
            t.production_mode,
            t.is_stage_complete,
            t.is_produce_complete,
            t.is_first_process,
            t.special_flag,
            t.plant_sid,
            t.serial_num,
            t.serial_num as serial_num_decimal,
            t.start_flag,
            t.end_flag,
            t.end_status,
            t.process_batch_num,
            t.picture_path,
            t.video_path,
            t.current_complete_quantity,
            t.quantity,
            t.COMMENT,
            t.cancel_flag,
            t.plan_start_date,
            t.actual_start_date,
            t.plan_end_date,
            t.initial_plan_end_date,
            t.actual_end_date,
            t.item_num,
            t.quantity_refer_process_sid,
            t.quantity_refer_process_code,
            t.quantity_type_refer_process,
            t.director_sid, t.director_code, t.is_produce_tg, t.plan_start_date_tg, t.actual_end_date_tg, t.is_produce_sp, t.plan_start_date_sp, t.actual_end_date_sp,
            t.department_sid,t.department_code,
            t.milestone,
            IFNULL(t.toexpire_days_scdd_gx,IFNULL(t11.toexpire_days_scdd_gx,IFNULL(t12.toexpire_days_scdd_gx,7))) as toexpire_days_scdd,
            t.toexpire_days_scdd_gx,
            t.remark,
            t.creator_account,
            t.create_date,
            t.updater_account,
            t.update_date,
            t.data_source_sys,
            t1.process_code,
            t2.plant_code,
            t2.plant_name,
            t2.short_name as plant_short_name,
            t3.work_center_code,
            t3.work_center_name,
            t4.staff_name as director_name,
            t5.manufacture_order_code,
            t5.material_sid,
            t6.material_name,
            t6.material_code,
            t7.process_name as quantity_refer_process_name,
            t8.name as department_name,
            t9.total_complete_quantity,
            IFNULL(t13.total_complete_quantity, 0) as total_complete_quantity_process,
            t10.is_caichuang_quantity as is_caichuang_quantity
        FROM
            s_man_manufacture_order_process t
                LEFT JOIN s_man_process t1 ON t1.process_sid = t.process_sid
                LEFT JOIN s_bas_plant t2 ON t2.plant_sid = t.plant_sid
                LEFT JOIN s_man_work_center t3 ON t3.work_center_sid = t.work_center_sid
                LEFT JOIN (
                SELECT ta.manufacture_order_process_sid,
                       GROUP_CONCAT(tb.staff_name ORDER BY tb.staff_name ASC SEPARATOR ';') as staff_name
                FROM s_man_manufacture_order_process ta
                         LEFT JOIN s_bas_staff tb ON (ta.director_code = tb.staff_code
                    or ta.director_code like concat('%;', tb.staff_code, ';%')
                    or ta.director_code like concat(tb.staff_code, ';%')
                    or ta.director_code like concat('%;', tb.staff_code))
                GROUP BY ta.manufacture_order_process_sid
            ) t4 ON t.manufacture_order_process_sid = t4.manufacture_order_process_sid
                LEFT JOIN s_man_manufacture_order t5 ON t5.manufacture_order_sid = t.manufacture_order_sid
                LEFT JOIN s_bas_material t6 ON t6.material_sid = t5.material_sid
                LEFT JOIN s_man_process t7 ON t.quantity_refer_process_sid = t7.process_sid
                LEFT JOIN s_con_manufacture_department t8 ON t.department_sid = t8.sid
                LEFT JOIN (
                SELECT t1.plant_sid,t1.work_center_sid,t1.handle_status,t.manufacture_order_sid,t.manufacture_order_process_sid,t.day_manufacture_progress_item_sid,
                       SUM(t.quantity) as total_complete_quantity
                FROM s_man_day_manufacture_progress_item t
                         LEFT JOIN s_man_day_manufacture_progress t1 ON t.day_manufacture_progress_sid = t1.day_manufacture_progress_sid
                WHERE t1.handle_status = '5'
                GROUP BY t1.plant_sid,t1.work_center_sid,t.manufacture_order_sid,t.manufacture_order_process_sid
            ) t9 ON t.manufacture_order_process_sid = t9.manufacture_order_process_sid and t.plant_sid = t9.plant_sid and t.work_center_sid = t9.work_center_sid
                and t.manufacture_order_sid = t9.manufacture_order_sid
                LEFT JOIN (
                SELECT t.manufacture_order_sid, t2.plant_sid, SUM(t.quantity) as is_caichuang_quantity
                FROM s_man_day_manufacture_progress_item t
                         LEFT JOIN s_man_day_manufacture_progress t1 ON t.day_manufacture_progress_sid = t1.day_manufacture_progress_sid
                         LEFT JOIN s_man_manufacture_order_process t2 ON t.manufacture_order_process_sid = t2.manufacture_order_process_sid
                WHERE t1.handle_status = '5' AND t2.is_first_process = 'Y'
                GROUP BY t.manufacture_order_sid, t2.plant_sid
            ) t10 ON t.manufacture_order_sid = t10.manufacture_order_sid and (t.plant_sid = t10.plant_sid or (t.plant_sid is null and t10.plant_sid is null))
                LEFT JOIN (
                SELECT t2.manufacture_order_sid, t2.process_sid, SUM(t.quantity) as total_complete_quantity
                FROM s_man_day_manufacture_progress_item t
                         LEFT JOIN s_man_day_manufacture_progress t1 ON t.day_manufacture_progress_sid = t1.day_manufacture_progress_sid
                         LEFT JOIN s_man_manufacture_order_process t2 ON t.manufacture_order_process_sid = t2.manufacture_order_process_sid
                WHERE t1.handle_status = '5'
                GROUP BY t2.manufacture_order_sid, t2.process_sid
            ) t13 ON t.manufacture_order_sid = t13.manufacture_order_sid and t.process_sid = t13.process_sid
                LEFT JOIN s_sys_default_setting_client t11 ON t.client_id = t11.client_id AND t11.handle_status = '5'
                LEFT JOIN s_sys_default_setting_system t12 ON t12.client_id = '10000'
    </sql>

    <select id="selectManManufactureOrderProcessById" parameterType="Long"
            resultMap="ManManufactureOrderProcessResult">
        <include refid="selectManManufactureOrderProcessVo"/>
        where t.manufacture_order_process_sid = #{manufactureOrderProcessSid}
    </select>

    <select id="selectManManufactureOrderProcessList" parameterType="com.platform.ems.domain.ManManufactureOrderProcess"
            resultMap="ManManufactureOrderProcessResult">
        <include refid="selectManManufactureOrderProcessVo"/>
        <where>
            <if test="clientId != null and clientId != ''">and t.client_id = #{clientId}
            </if>
            <if test="manufactureOrderSid != null  ">
                and t.manufacture_order_sid = #{manufactureOrderSid}
            </if>
            <if test="processSid != null  ">
                and t.process_sid = #{processSid}
            </if>
            <if test="isFirstProcess != null and isFirstProcess != ''">
                and t.is_first_process = #{isFirstProcess}
            </if>
            <if test="processName != null and processName != ''">and (
                <foreach collection="processName.split(';')" item="item" separator="or">t.process_name like concat('%',
                    #{item}, '%')</foreach>)
            </if>
            <if test="workCenterSid != null  ">
                and t.work_center_sid = #{workCenterSid}
            </if>
            <if test="plantSid != null  ">
                and t.plant_sid = #{plantSid}
            </if>
            <if test="processBatchNum != null">
                and t.process_batch_num = #{processBatchNum}
            </if>
            <if test="serialNum != null ">and t.serial_num in (
                <foreach collection="serialNum" item="item" separator=",">#{item}</foreach>)
            </if>
            <if test="quantityReferProcessSid != null">
                and t.quantity_refer_process_sid = #{quantityReferProcessSid}
            </if>
            <if test="quantityReferProcessCode != null">
                and t.quantity_refer_process_code  like concat('%', #{quantityReferProcessCode}, '%')
            </if>
            <if test="quantityTypeReferProcess != null and quantityTypeReferProcess != ''">
                and t.quantity_type_refer_process = #{quantityTypeReferProcess}
            </if>
            <if test="startFlag != null and startFlag != ''">and t.start_flag = #{startFlag}
            </if>
            <if test="endFlag != null and endFlag != ''">and t.end_flag = #{endFlag}
            </if>
            <if test="endStatus != null and endStatus != ''">
                and t.end_status = #{endStatus}
            </if>
            <if test="currentCompleteQuantity != null ">and t.current_complete_quantity in (
                <foreach collection="currentCompleteQuantity" item="item" separator=",">#{item}</foreach>)
            </if>
            <if test="quantity != null ">and t.quantity = #{quantity}</if>
            <if test="comment != null and comment != ''">and (
                <foreach collection="comment.split(';')" item="item" separator="or">t.comment like concat('%', #{item},
                    '%')</foreach>)
            </if>
            <if test="cancelFlag != null and cancelFlag != ''">and t.cancel_flag = #{cancelFlag}
            </if>
            <if test="planStartDate != null ">and t.plan_start_date = #{planStartDate}</if>
            <if test="actualStartDate != null ">and t.actual_start_date = #{actualStartDate}</if>
            <if test="planEndDate != null ">and t.plan_end_date = #{planEndDate}</if>
            <if test="actualEndDate != null ">and t.actual_end_date = #{actualEndDate}</if>

            <if test="directorSid != null ">
                and t.director_sid = #{directorSid}
            </if>
            <if test="directorCode != null and directorCode != ''">
                and t.director_code = #{directorCode}
            </if>
            <if test="isProduceTg != null and isProduceTg != ''">
                and t.is_produce_tg = #{isProduceTg}
            </if>
            <if test="planStartDateTg != null ">
                and t.plan_start_date_tg = #{planStartDateTg}
            </if>
            <if test="actualEndDateTg != null ">
                and t.actual_end_date_tg = #{actualEndDateTg}
            </if>
            <if test="isProduceSp != null and isProduceSp != ''">
                and t.is_produce_sp = #{isProduceSp}
            </if>
            <if test="planStartDateSp != null ">
                and t.plan_start_date_sp = #{planStartDateSp}
            </if>
            <if test="actualEndDateSp != null ">
                and t.actual_end_date_sp = #{actualEndDateSp}
            </if>
            <if test="departmentSid != null ">
                and t.department_sid = #{departmentSid}
            </if>
            <if test="creatorAccount != null  and creatorAccount != ''">and (
                <foreach collection="creatorAccount.split(';')" item="item" separator="or">t.creator_account like
                    concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="beginTime != null and beginTime!=''">and date_format(t.create_date,'%y%m%d') &gt;=
                date_format(#{beginTime},'%y%m%d')
            </if>
            <if test="endTime != null and endTime!=''">and date_format(t.create_date,'%y%m%d') &lt;=
                date_format(#{endTime},'%y%m%d')
            </if>
            <if test="updaterAccount != null  and updaterAccount != ''">and (
                <foreach collection="updaterAccount.split(';')" item="item" separator="or">t.updater_account like
                    concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="updateDate != null ">and t.update_date = #{updateDate}</if>
            <if test="dataSourceSys != null  and dataSourceSys != ''">and (
                <foreach collection="dataSourceSys.split(';')" item="item" separator="or">t.data_source_sys like
                    concat('%', #{item}, '%')</foreach>)
            </if>
        </where>
    </select>
    <!--添加多个-->
    <insert id="inserts">
        insert into s_man_manufacture_order_process
        <trim prefix="(" suffix=")" suffixOverrides=",">
            client_id,
            manufacture_order_process_sid,
            manufacture_order_sid,
            manufacture_order_code,
            process_sid,
            process_name,
            work_center_sid,
            plant_sid,
            serial_num,
            production_mode,
            process_batch_num,
            is_stage_complete,
            is_produce_complete,
            is_first_process,
            special_flag,
            start_flag,
            end_flag,
            quantity,
            current_complete_quantity,
            end_status,
            comment,
            cancel_flag,
            plan_start_date,
            actual_start_date,
            plan_end_date,
            initial_plan_end_date,
            actual_end_date,
            department_sid,
            department_code,
            milestone,
            item_num,
            quantity_refer_process_sid,
            quantity_refer_process_code,
            quantity_type_refer_process,
            director_sid,
            director_code,
            is_produce_tg,
            plan_start_date_tg,
            actual_end_date_tg,
            is_produce_sp,
            plan_start_date_sp,
            actual_end_date_sp,
            toexpire_days_scdd_gx,
            remark,
            creator_account,
            create_date,
            updater_account,
            update_date,
            data_source_sys,
        </trim>
        values
        <foreach collection="list" item="item" separator=",">
            <trim prefix=" (" suffix=")" suffixOverrides=",">
                #{item.clientId},
                #{item.manufactureOrderProcessSid},
                #{item.manufactureOrderSid},
                #{item.manufactureOrderCode},
                #{item.processSid},
                #{item.processName},
                #{item.workCenterSid},
                #{item.plantSid},
                #{item.serialNum},
                #{item.productionMode},
                #{item.processBatchNum},
                #{item.isStageComplete},
                #{item.isProduceComplete},
                #{item.isFirstProcess},
                #{item.specialFlag},
                #{item.startFlag},
                #{item.endFlag},
                #{item.quantity},
                #{item.currentCompleteQuantity},
                #{item.endStatus},
                #{item.comment},
                #{item.cancelFlag},
                #{item.planStartDate},
                #{item.actualStartDate},
                #{item.planEndDate},
                #{item.initialPlanEndDate},
                #{item.actualEndDate},
                #{item.departmentSid},
                #{item.departmentCode},
                #{item.milestone},
                #{item.itemNum},
                #{item.quantityReferProcessSid},
                #{item.quantityReferProcessCode},
                #{item.quantityTypeReferProcess},
                #{item.directorSid},
                #{item.directorCode},
                #{item.isProduceTg},
                #{item.planStartDateTg},
                #{item.actualEndDateTg},
                #{item.isProduceSp},
                #{item.planStartDateSp},
                #{item.actualEndDateSp},
                #{item.toexpireDaysScddGx},
                #{item.remark},
                #{item.creatorAccount},
                #{item.createDate},
                #{item.updaterAccount},
                #{item.updateDate},
                #{item.dataSourceSys},
            </trim>
        </foreach>
    </insert>

    <!--更新-->
    <update id="updateAllById">
        update s_man_manufacture_order_process
        <trim prefix="SET" suffixOverrides=",">
            manufacture_order_sid = #{manufactureOrderSid},
            manufacture_order_code = #{manufactureOrderCode},
            process_sid = #{processSid},
            process_name = #{processName},
            work_center_sid = #{workCenterSid},
            plant_sid = #{plantSid},
            serial_num = #{serialNum},
            production_mode = #{productionMode},
            process_batch_num = #{processBatchNum},
            is_stage_complete = #{isStageComplete},
            is_produce_complete = #{isProduceComplete},
            is_first_process = #{isFirstProcess},
            special_flag = #{specialFlag},
            start_flag = #{startFlag},
            end_flag = #{endFlag},
            quantity = #{quantity},
            current_complete_quantity = #{currentCompleteQuantity},
            end_status = #{endStatus},
            comment = #{comment},
            cancel_flag = #{cancelFlag},
            plan_start_date = #{planStartDate},
            actual_start_date = #{actualStartDate},
            plan_end_date = #{planEndDate},
            initial_plan_end_date = #{initialPlanEndDate},
            actual_end_date = #{actualEndDate},
            item_num = #{itemNum},
            quantity_refer_process_sid = #{quantityReferProcessSid},
            quantity_refer_process_code = #{quantityReferProcessCode},
            quantity_type_refer_process = #{quantityTypeReferProcess},
            director_sid = #{directorSid},
            director_code = #{directorCode},
            is_produce_tg = #{isProduceTg},
            plan_start_date_tg = #{planStartDateTg},
            actual_end_date_tg = #{actualEndDateTg},
            is_produce_sp = #{isProduceSp},
            plan_start_date_sp = #{planStartDateSp},
            actual_end_date_sp = #{actualEndDateSp},
            department_sid = #{departmentSid},
            department_code = #{departmentCode},
            milestone = #{milestone},
            toexpire_days_scdd_gx = #{toexpireDaysScddGx},
            remark = #{remark},
            updater_account = #{updaterAccount},
            update_date = #{updateDate},
            data_source_sys = #{dataSourceSys},
        </trim>
        where manufacture_order_process_sid = #{manufactureOrderProcessSid}
    </update>

    <!--更新多个-->
    <update id="updatesAllById">
        <foreach collection="list" item="item" separator=";">
            update s_man_manufacture_order_process
            <trim prefix="SET" suffixOverrides=",">
                plan_end_date = #{item.planEndDate},
            </trim>
            where manufacture_order_sid = #{item.manufactureOrderSid}
            and  work_center_sid = #{item.workCenterSid}
            and    process_sid = #{item.processSid}
        </foreach>
    </update>

    <sql id="getItemListVo">
        SELECT
        t.client_id,
        t.manufacture_order_process_sid,
        t.manufacture_order_sid,
        t.process_sid,
        t.process_name,
        t.work_center_sid,
        t.plant_sid,
        t.serial_num,
        t.production_mode,
        t.is_stage_complete,
        t.is_produce_complete,
        t.is_first_process,
        t.special_flag,
        t.is_produce_tg,
        t.plan_start_date_tg,
        t.actual_end_date_tg,
        t.is_produce_sp,
        t.plan_start_date_sp,
        t.actual_end_date_sp,
        t.start_flag,
        t.end_flag,
        t.end_status,
        t.current_complete_quantity,
        t.process_batch_num,
        t.picture_path,
        t.video_path,
        t.quantity,
        t.COMMENT,
        t.cancel_flag,
        t.plan_start_date,
        t.actual_start_date,
        t.plan_end_date,
        t.initial_plan_end_date,
        t.actual_end_date,
        t.department_sid,
        t.department_code,
        t.milestone,
        t.director_sid,
        t.director_code,
        t.item_num,
        t.quantity_refer_process_sid,
        t.quantity_refer_process_code,
        t.quantity_type_refer_process,
        t.remark,
        t.creator_account,
        t.create_date,
        t.updater_account,
        t.update_date,
        t.data_source_sys,
        t1.manufacture_order_code,
        t1.plant_sid as order_plant_sid,
        t1.quantity as plan_order_quantity,
        t1a.sku_name as sku1_name,
        t.toexpire_days_scdd_gx,
        IFNULL(t.toexpire_days_scdd_gx,IFNULL(t18.toexpire_days_scdd_gx,IFNULL(t19.toexpire_days_scdd_gx,7))) as toexpire_days_scdd,
        t4.plant_code as order_plant_code,
        t4.plant_name as order_plant_name,
        t4.short_name as order_plant_short_name,
        t4.company_sid,
        t1.material_sid,
        t1.paichan_batch,
        t1.material_name,
        t1.handle_status,
        t1.complete_status,
        t1.plan_end_date as plan_end_date_head,
        t5.material_code,
        t5.unit_base,
        t7.process_name as quantity_refer_process_name,
        t8.process_code,
        t9.plant_code,
        t9.plant_name,
        t9.short_name as plant_short_name,
        t10.work_center_code,
        t10.work_center_name,
        t11.name as unit_base_name,
        t12.staff_name as director_name,
        t13.nick_name as creator_account_name,
        t14.nick_name as updater_account_name,
        t16.name as department_name,
        t20.actual_quantity as tou_gang_quantity,
        t23.actual_quantity as shou_pi_quantity,
        t24.quantity as plan_total_quantity,
        t26.short_name as work_vendor_short_name,
        IFNULL(t17.total_complete_quantity, 0) AS total_complete_quantity,
        IFNULL(t30.is_caichuang_quantity, 0) AS is_caichuang_quantity,
        (t.quantity - ifnull(t17a.total_complete_quantity, 0)) as dai_quantity,
        (IFNULL(t30.is_caichuang_quantity, 0) - IFNULL(t17a.total_complete_quantity, 0)) AS dai_shicai_quantity,
        t17a.total_complete_quantity as total_complete_quantity_process,
        (IFNULL(t.quantity, 0) - IFNULL(t17.total_complete_quantity, 0)) AS plan_unfinished_quantity
        FROM s_man_manufacture_order_process t
        LEFT JOIN s_man_manufacture_order t1 ON t1.manufacture_order_sid = t.manufacture_order_sid
        LEFT JOIN s_bas_sku t1a ON t1.sku_sid = t1a.sku_sid
        LEFT JOIN s_sys_default_setting_client t18 ON t.client_id = t18.client_id AND t18.handle_status = '5'
        LEFT JOIN s_sys_default_setting_system t19 ON t19.client_id = '10000'
        LEFT JOIN s_man_process t7 ON t.quantity_refer_process_sid = t7.process_sid
        LEFT JOIN s_man_process t8 ON t8.process_sid = t.process_sid
        LEFT JOIN s_bas_plant t9 ON t9.plant_sid = t.plant_sid
        LEFT JOIN s_man_work_center t10 ON t10.work_center_sid = t.work_center_sid
        LEFT JOIN s_bas_vendor t26 ON t10.vendor_sid = t26.vendor_sid
        LEFT JOIN s_bas_plant t4 ON t4.plant_sid = t1.plant_sid
        LEFT JOIN s_bas_material t5 ON t5.material_sid = t1.material_sid
        LEFT JOIN s_con_measure_unit t11 on t11.code = t5.unit_base
        LEFT JOIN (
        SELECT ta.manufacture_order_process_sid,
        GROUP_CONCAT(tb.staff_name ORDER BY tb.staff_name ASC SEPARATOR ';') as staff_name
        FROM s_man_manufacture_order_process ta
        LEFT JOIN s_bas_staff tb ON (ta.director_code = tb.staff_code
        or ta.director_code like concat('%;', tb.staff_code, ';%')
        or ta.director_code like concat(tb.staff_code, ';%')
        or ta.director_code like concat('%;', tb.staff_code))
        GROUP BY ta.manufacture_order_process_sid
        ) t12 ON t.manufacture_order_process_sid = t12.manufacture_order_process_sid
        LEFT JOIN sys_user t13 ON t13.user_name = t.creator_account
        LEFT JOIN sys_user t14 ON t14.user_name = t.updater_account
        LEFT JOIN s_con_manufacture_department t16 ON t.department_sid = t16.sid
        LEFT JOIN (
        SELECT t.work_center_sid, t.manufacture_order_process_sid, t.sku1_sid, SUM(t.quantity) as total_complete_quantity
        FROM s_man_day_manufacture_progress_item t
        LEFT JOIN s_man_day_manufacture_progress t1 ON t.day_manufacture_progress_sid = t1.day_manufacture_progress_sid
        WHERE t1.handle_status = '5' and t.sku1_sid is null
        <if test="workCenterSid != null">
            and t.work_center_sid = #{workCenterSid}
        </if>
        GROUP BY t.work_center_sid, t.manufacture_order_process_sid, t.sku1_sid
        ) t17 ON t.manufacture_order_process_sid = t17.manufacture_order_process_sid
        LEFT JOIN (
        SELECT t.manufacture_order_process_sid, SUM(t.quantity) as total_complete_quantity
        FROM s_man_day_manufacture_progress_item t
        LEFT JOIN s_man_day_manufacture_progress t1 ON t.day_manufacture_progress_sid = t1.day_manufacture_progress_sid
        WHERE t1.handle_status = '5'
        GROUP BY t.manufacture_order_process_sid
        ) t17a ON t.manufacture_order_process_sid = t17a.manufacture_order_process_sid
        left join (
        select max(t18.actual_quantity) as actual_quantity,t18.manufacture_order_sid
        from s_man_manufacture_order_concern_task t18
        left join s_man_produce_concern_task t19 on t19.concern_task_sid=t18.concern_task_sid
        where  t19.concern_task_type='TG'
        GROUP BY t18.manufacture_order_sid
        ) t20 on t20.manufacture_order_sid=t.manufacture_order_sid
        left join (
        select max(t21.actual_quantity) as actual_quantity,t21.manufacture_order_sid
        from s_man_manufacture_order_concern_task t21
        left join s_man_produce_concern_task t22 on t22.concern_task_sid=t21.concern_task_sid
        where  t22.concern_task_type='SP'
        GROUP BY t21.manufacture_order_sid
        ) t23 on t23.manufacture_order_sid=t.manufacture_order_sid
        LEFT JOIN (
        select manufacture_order_sid, sum(quantity) as quantity from s_man_manufacture_order_product group by manufacture_order_sid
        ) t24 ON t24.manufacture_order_sid = t.manufacture_order_sid
        left join s_con_manufacture_department t25 on t25.sid=t.department_sid
        LEFT JOIN (
        SELECT t.manufacture_order_sid, t2.plant_sid, SUM(t.quantity) as is_caichuang_quantity
        FROM s_man_day_manufacture_progress_item t
        LEFT JOIN s_man_day_manufacture_progress t1 ON t.day_manufacture_progress_sid = t1.day_manufacture_progress_sid
        LEFT JOIN s_man_manufacture_order_process t2 ON t.manufacture_order_process_sid = t2.manufacture_order_process_sid
        WHERE t1.handle_status = '5' AND t2.is_first_process = 'Y'
        GROUP BY t.manufacture_order_sid, t2.plant_sid
        ) t30 ON t.manufacture_order_sid = t30.manufacture_order_sid and (t.plant_sid = t30.plant_sid or (t.plant_sid is null and t30.plant_sid is null))
    </sql>

    <sql id="getItemKListVo">
        SELECT
        t.client_id,
        t.manufacture_order_process_sid,
        t.manufacture_order_sid,
        t.process_sid,
        t.process_name,
        t.work_center_sid,
        t.plant_sid,
        t.serial_num,
        t.production_mode,
        t.is_stage_complete,
        t.is_produce_complete,
        t.is_first_process,
        t.special_flag,
        t.is_produce_tg,
        t.plan_start_date_tg,
        t.actual_end_date_tg,
        t.is_produce_sp,
        t.plan_start_date_sp,
        t.actual_end_date_sp,
        t.start_flag,
        t.end_flag,
        t.end_status,
        t.current_complete_quantity,
        t.process_batch_num,
        t.picture_path,
        t.video_path,
        t.quantity,
        t.COMMENT,
        t.cancel_flag,
        t.plan_start_date,
        t.actual_start_date,
        t.plan_end_date,
        t.initial_plan_end_date,
        t.actual_end_date,
        t.department_sid,
        t.department_code,
        t.milestone,
        t.director_sid,
        t.director_code,
        t.item_num,
        t.quantity_refer_process_sid,
        t.quantity_refer_process_code,
        t.quantity_type_refer_process,
        t.remark,
        t.creator_account,
        t.create_date,
        t.updater_account,
        t.update_date,
        t.data_source_sys,
        t1.manufacture_order_code,
        t1.plant_sid as order_plant_sid,
        t1.quantity as plan_order_quantity,
        t.toexpire_days_scdd_gx,
        IFNULL(t.toexpire_days_scdd_gx,IFNULL(t18.toexpire_days_scdd_gx,IFNULL(t19.toexpire_days_scdd_gx,7))) as toexpire_days_scdd,
        t4.plant_code as order_plant_code,
        t4.plant_name as order_plant_name,
        t4.short_name as order_plant_short_name,
        t4.company_sid,
        t1.material_sid,
        t1.paichan_batch,
        t1.material_name,
        t1.handle_status,
        t1.complete_status,
        t1.plan_end_date as plan_end_date_head,
        t5.material_code,
        t5.unit_base,
        t7.process_name as quantity_refer_process_name,
        t8.process_code,
        t9.plant_code,
        t9.plant_name,
        t9.short_name as plant_short_name,
        t10.work_center_code,
        t10.work_center_name,
        t11.name as unit_base_name,
        t12.staff_name as director_name,
        t13.nick_name as creator_account_name,
        t14.nick_name as updater_account_name,
        t16.name as department_name,
        t20.actual_quantity as tou_gang_quantity,
        t23.actual_quantity as shou_pi_quantity,
        t24.quantity as plan_total_quantity,
        t26.short_name as work_vendor_short_name,
        IFNULL(t17.total_complete_quantity, 0) AS total_complete_quantity,
        IFNULL(t30.is_caichuang_quantity, 0) AS is_caichuang_quantity,
        (IFNULL(t.quantity, 0) - IFNULL(t17.total_complete_quantity, 0)) AS plan_unfinished_quantity
        FROM s_man_manufacture_order_process t
        LEFT JOIN s_man_manufacture_order t1 ON t1.manufacture_order_sid = t.manufacture_order_sid
        LEFT JOIN s_sys_default_setting_client t18 ON t.client_id = t18.client_id AND t18.handle_status = '5'
        LEFT JOIN s_sys_default_setting_system t19 ON t19.client_id = '10000'
        LEFT JOIN s_man_process t7 ON t.quantity_refer_process_sid = t7.process_sid
        LEFT JOIN s_man_process t8 ON t8.process_sid = t.process_sid
        LEFT JOIN s_bas_plant t9 ON t9.plant_sid = t.plant_sid
        LEFT JOIN s_man_work_center t10 ON t10.work_center_sid = t.work_center_sid
        LEFT JOIN s_bas_vendor t26 ON t10.vendor_sid = t26.vendor_sid
        LEFT JOIN s_bas_plant t4 ON t4.plant_sid = t1.plant_sid
        LEFT JOIN s_bas_material t5 ON t5.material_sid = t1.material_sid
        LEFT JOIN s_con_measure_unit t11 on t11.code = t5.unit_base
        LEFT JOIN (
        SELECT ta.manufacture_order_process_sid,
        GROUP_CONCAT(tb.staff_name ORDER BY tb.staff_name ASC SEPARATOR ';') as staff_name
        FROM s_man_manufacture_order_process ta
        LEFT JOIN s_bas_staff tb ON (ta.director_code = tb.staff_code
        or ta.director_code like concat('%;', tb.staff_code, ';%')
        or ta.director_code like concat(tb.staff_code, ';%')
        or ta.director_code like concat('%;', tb.staff_code))
        GROUP BY ta.manufacture_order_process_sid
        ) t12 ON t.manufacture_order_process_sid = t12.manufacture_order_process_sid
        LEFT JOIN sys_user t13 ON t13.user_name = t.creator_account
        LEFT JOIN sys_user t14 ON t14.user_name = t.updater_account
        LEFT JOIN s_con_manufacture_department t16 ON t.department_sid = t16.sid
        LEFT JOIN (
        SELECT t.work_center_sid, t.manufacture_order_process_sid, t.sku1_sid, SUM(t.quantity) as total_complete_quantity
        FROM s_man_day_manufacture_progress_item t
        LEFT JOIN s_man_day_manufacture_progress t1 ON t.day_manufacture_progress_sid = t1.day_manufacture_progress_sid
        WHERE t1.handle_status = '5' and t.sku1_sid is null
        <if test="workCenterSid != null">
            and t.work_center_sid = #{workCenterSid}
        </if>
        GROUP BY t.work_center_sid, t.manufacture_order_process_sid, t.sku1_sid
        ) t17 ON t.manufacture_order_process_sid = t17.manufacture_order_process_sid
        left join (
        select max(t18.actual_quantity) as actual_quantity,t18.manufacture_order_sid
        from s_man_manufacture_order_concern_task t18
        left join s_man_produce_concern_task t19 on t19.concern_task_sid=t18.concern_task_sid
        where  t19.concern_task_type='TG'
        GROUP BY t18.manufacture_order_sid
        ) t20 on t20.manufacture_order_sid=t.manufacture_order_sid
        left join (
        select max(t21.actual_quantity) as actual_quantity,t21.manufacture_order_sid
        from s_man_manufacture_order_concern_task t21
        left join s_man_produce_concern_task t22 on t22.concern_task_sid=t21.concern_task_sid
        where  t22.concern_task_type='SP'
        GROUP BY t21.manufacture_order_sid
        ) t23 on t23.manufacture_order_sid=t.manufacture_order_sid
        LEFT JOIN (
        select manufacture_order_sid, sum(quantity) as quantity from s_man_manufacture_order_product group by manufacture_order_sid
        ) t24 ON t24.manufacture_order_sid = t.manufacture_order_sid
        left join s_con_manufacture_department t25 on t25.sid=t.department_sid
        LEFT JOIN (
        SELECT t.manufacture_order_sid, t2.plant_sid, SUM(t.quantity) as is_caichuang_quantity
        FROM s_man_day_manufacture_progress_item t
        LEFT JOIN s_man_day_manufacture_progress t1 ON t.day_manufacture_progress_sid = t1.day_manufacture_progress_sid
        LEFT JOIN s_man_manufacture_order_process t2 ON t.manufacture_order_process_sid = t2.manufacture_order_process_sid
        WHERE t1.handle_status = '5' AND t2.is_first_process = 'Y'
        GROUP BY t.manufacture_order_sid, t2.plant_sid
        ) t30 ON t.manufacture_order_sid = t30.manufacture_order_sid and (t.plant_sid = t30.plant_sid or (t.plant_sid is null and t30.plant_sid is null))
    </sql>

    <sql id="getItemListK1Vo">
        SELECT
            t.client_id,
            t.manufacture_order_process_sid,
            t.manufacture_order_sid,
            t.process_sid,
            t.process_name,
            t.work_center_sid,
            t.plant_sid,
            t.serial_num,
            t.production_mode,
            t.is_stage_complete,
            t.is_produce_complete,
            t.is_first_process,
            t.special_flag,
            t.is_produce_tg,
            t.plan_start_date_tg,
            t.actual_end_date_tg,
            t.is_produce_sp,
            t.plan_start_date_sp,
            t.actual_end_date_sp,
            t.start_flag,
            t.end_flag,
            t.end_status,
            t.current_complete_quantity,
            t.process_batch_num,
            t.picture_path,
            t.video_path,
            t.quantity,
            t.COMMENT,
            t.cancel_flag,
            t.plan_start_date,
            t.actual_start_date,
            t.plan_end_date,
            t.initial_plan_end_date,
            t.actual_end_date,
            t.department_sid,
            t.department_code,
            t.milestone,
            t.director_sid,
            t.director_code,
            t.item_num,
            t.quantity_refer_process_sid,
            t.quantity_refer_process_code,
            t.quantity_type_refer_process,
            t.remark,
            t.creator_account,
            t.create_date,
            t.updater_account,
            t.update_date,
            t.data_source_sys,
            t1.manufacture_order_code,
            t1.plant_sid as order_plant_sid,
            t1.quantity as plan_order_quantity,
            t.toexpire_days_scdd_gx,
            IFNULL(t.toexpire_days_scdd_gx,IFNULL(t18.toexpire_days_scdd_gx,IFNULL(t19.toexpire_days_scdd_gx,7))) as toexpire_days_scdd,
            t4.plant_code as order_plant_code,
            t4.plant_name as order_plant_name,
            t4.short_name as order_plant_short_name,
            t4.company_sid,
            t1.material_sid,
            t1.paichan_batch,
            t1.material_name,
            t1.handle_status,
            t1.complete_status,
            t1.plan_end_date as plan_end_date_head,
            t5.material_code,
            t5.unit_base,
            t7.process_name as quantity_refer_process_name,
            t8.process_code,
            t9.plant_code,
            t9.plant_name,
            t9.short_name as plant_short_name,
            t10.work_center_code,
            t10.work_center_name,
            t11.name as unit_base_name,
            t12.staff_name as director_name,
            t13.nick_name as creator_account_name,
            t14.nick_name as updater_account_name,
            t16.name as department_name,
            t20.actual_quantity as tou_gang_quantity,
            t23.actual_quantity as shou_pi_quantity,
            t24.plan_total_quantity,
            t26.short_name as work_vendor_short_name,
            t30.is_caichuang_quantity,
            t32.sku_name as sku1_name,
            t32.sku_code as sku1_code,
            t32.sku_sid as sku1_sid,
            t32.sku_type as sku1_type
        FROM s_man_manufacture_order_process t
                 LEFT JOIN s_man_manufacture_order t1 ON t1.manufacture_order_sid = t.manufacture_order_sid
                 LEFT JOIN s_sys_default_setting_client t18 ON t.client_id = t18.client_id AND t18.handle_status = '5'
                 LEFT JOIN s_sys_default_setting_system t19 ON t19.client_id = '10000'
                 LEFT JOIN s_man_process t7 ON t.quantity_refer_process_sid = t7.process_sid
                 LEFT JOIN s_man_process t8 ON t8.process_sid = t.process_sid
                 LEFT JOIN s_bas_plant t9 ON t9.plant_sid = t.plant_sid
                 LEFT JOIN s_man_work_center t10 ON t10.work_center_sid = t.work_center_sid
                 LEFT JOIN s_bas_vendor t26 ON t10.vendor_sid = t26.vendor_sid
                 LEFT JOIN s_bas_plant t4 ON t4.plant_sid = t1.plant_sid
                 LEFT JOIN s_bas_material t5 ON t5.material_sid = t1.material_sid
                 LEFT JOIN s_con_measure_unit t11 on t11.code = t5.unit_base
                 LEFT JOIN (
            SELECT ta.manufacture_order_process_sid,
                   GROUP_CONCAT(tb.staff_name ORDER BY tb.staff_name ASC SEPARATOR ';') as staff_name
            FROM s_man_manufacture_order_process ta
                     LEFT JOIN s_bas_staff tb ON (ta.director_code = tb.staff_code
                or ta.director_code like concat('%;', tb.staff_code, ';%')
                or ta.director_code like concat(tb.staff_code, ';%')
                or ta.director_code like concat('%;', tb.staff_code))
            GROUP BY ta.manufacture_order_process_sid
        ) t12 ON t.manufacture_order_process_sid = t12.manufacture_order_process_sid
                 LEFT JOIN sys_user t13 ON t13.user_name = t.creator_account
                 LEFT JOIN sys_user t14 ON t14.user_name = t.updater_account
                 LEFT JOIN s_con_manufacture_department t16 ON t.department_sid = t16.sid
                 left join (
            select max(t18.actual_quantity) as actual_quantity,t18.manufacture_order_sid
            from
                s_man_manufacture_order_concern_task t18
                    left join s_man_produce_concern_task t19 on t19.concern_task_sid=t18.concern_task_sid
            where  t19.concern_task_type='TG'
            GROUP BY t18.manufacture_order_sid
        ) t20 on t20.manufacture_order_sid=t.manufacture_order_sid
                 left join (
            select max(t21.actual_quantity) as actual_quantity,t21.manufacture_order_sid
            from
                s_man_manufacture_order_concern_task t21
                    left join s_man_produce_concern_task t22 on t22.concern_task_sid=t21.concern_task_sid
            where  t22.concern_task_type='SP'
            GROUP BY t21.manufacture_order_sid
        ) t23 on t23.manufacture_order_sid=t.manufacture_order_sid
                 LEFT JOIN (

            select sum(t.quantity) as plan_total_quantity,
                   t.manufacture_order_sid
            from
                s_man_manufacture_order_product t
            group by t.manufacture_order_sid
        )  t24 ON t24.manufacture_order_sid = t.manufacture_order_sid
                 left join s_con_manufacture_department t25 on t25.sid=t.department_sid
                 left join s_man_manufacture_order_product t31 ON t31.manufacture_order_sid = t.manufacture_order_sid
                 LEFT JOIN s_bas_sku t32 ON t31.sku1_sid = t32.sku_sid
                 LEFT JOIN (
            SELECT t.manufacture_order_sid, t2.plant_sid, SUM(t.quantity) as is_caichuang_quantity
            FROM s_man_day_manufacture_progress_item t
                     LEFT JOIN s_man_day_manufacture_progress t1 ON t.day_manufacture_progress_sid = t1.day_manufacture_progress_sid
                     LEFT JOIN s_man_manufacture_order_process t2 ON t.manufacture_order_process_sid = t2.manufacture_order_process_sid
            WHERE t1.handle_status = '5' AND t2.is_first_process = 'Y'
            GROUP BY t.manufacture_order_sid, t2.plant_sid
        ) t30 on t.manufacture_order_sid = t30.manufacture_order_sid and (t.plant_sid = t30.plant_sid or (t.plant_sid is null and t30.plant_sid is null))
    </sql>

    <sql id="getSkuItemListVo">
        SELECT
            t.client_id,
            t.manufacture_order_process_sid,
            t.manufacture_order_sid,
            t.process_sid,
            t.process_name,
            t.work_center_sid,
            t.plant_sid,
            t.serial_num,
            t.production_mode,
            t.is_stage_complete,
            t.is_produce_complete,
            t.is_first_process,
            t.start_flag,
            t.end_flag,
            t.end_status,
            t.special_flag,
            t.current_complete_quantity,
            t.process_batch_num,
            t.picture_path,
            t.video_path,
            t.quantity,
            t.COMMENT,
            t.cancel_flag,
            t.plan_start_date,
            t.actual_start_date,
            t.plan_end_date,
            t.initial_plan_end_date,
            t.actual_end_date,
            t.department_sid,
            t.department_code,
            t.milestone,
            t.director_code,
            t.item_num,
            t.quantity_refer_process_sid,
            t.quantity_refer_process_code,
            t.quantity_type_refer_process,
            t.remark,
            t.creator_account,
            t.create_date,
            t.updater_account,
            t.update_date,
            t.data_source_sys,
            t1.manufacture_order_code,
            t1.plant_sid as order_plant_sid,
            t1.material_sid,
            t1.material_name,
            t1.paichan_batch,
            t2.sku1_sid,
            t2.sku2_sid,
            t3.sku_name as sku1_name,
            t3.sku_type as sku1_type,
            t4.plant_code as order_plant_code,
            t4.plant_name as order_plant_name,
            t4.company_sid,
            t5.material_code,
            t5.unit_base,
            t7.process_name as quantity_refer_process_name,
            t8.process_code,
            t9.plant_code,
            t9.plant_name,
            t10.work_center_code,
            t10.work_center_name,
            t11.name as unit_base_name,
            t12.staff_name as director_name,
            t13.nick_name as creator_account_name,
            t14.nick_name as updater_account_name,
            t15.name as department_name,
            IFNULL(t16.total_complete_quantity, 0) AS total_complete_quantity,
            IFNULL(t17.is_caichuang_quantity, 0) AS is_caichuang_quantity,
            (t.quantity - ifnull(t16.total_complete_quantity, 0)) as dai_quantity,
            (IFNULL(t17.is_caichuang_quantity, 0) - IFNULL(t16.total_complete_quantity, 0)) AS dai_shicai_quantity,
            (IFNULL(t.quantity, 0) - IFNULL(t16.total_complete_quantity, 0)) AS plan_unfinished_quantity
        FROM s_man_manufacture_order_process t
                 LEFT JOIN s_man_manufacture_order t1 ON t1.manufacture_order_sid = t.manufacture_order_sid
                 LEFT JOIN s_man_manufacture_order_product t2 ON t.manufacture_order_sid = t2.manufacture_order_sid
                 LEFT JOIN s_bas_sku t3 ON t2.sku1_sid = t3.sku_sid
                 LEFT JOIN s_bas_plant t4 ON t4.plant_sid = t1.plant_sid
                 LEFT JOIN s_bas_material t5 ON t5.material_sid = t1.material_sid
                 LEFT JOIN s_man_process t7 ON t.quantity_refer_process_sid = t7.process_sid
                 LEFT JOIN s_man_process t8 ON t8.process_sid = t.process_sid
                 LEFT JOIN s_bas_plant t9 ON t9.plant_sid = t.plant_sid
                 LEFT JOIN s_man_work_center t10 ON t10.work_center_sid = t.work_center_sid
                 LEFT JOIN s_con_measure_unit t11 on t11.code = t5.unit_base
                 LEFT JOIN (
            SELECT ta.manufacture_order_process_sid,
                   GROUP_CONCAT(tb.staff_name ORDER BY tb.staff_name ASC SEPARATOR ';') as staff_name
            FROM s_man_manufacture_order_process ta
                     LEFT JOIN s_bas_staff tb ON (ta.director_code = tb.staff_code
                or ta.director_code like concat('%;', tb.staff_code, ';%')
                or ta.director_code like concat(tb.staff_code, ';%')
                or ta.director_code like concat('%;', tb.staff_code))
            GROUP BY ta.manufacture_order_process_sid
        ) t12 ON t.manufacture_order_process_sid = t12.manufacture_order_process_sid
                 LEFT JOIN sys_user t13 ON t13.user_name = t.creator_account
                 LEFT JOIN sys_user t14 ON t14.user_name = t.updater_account
                 LEFT JOIN s_con_manufacture_department t15 ON t.department_sid = t15.sid
                 LEFT JOIN (
            SELECT t.manufacture_order_process_sid, SUM(t.quantity) as total_complete_quantity
            FROM s_man_day_manufacture_progress_item t
                     LEFT JOIN s_man_day_manufacture_progress t1 ON t.day_manufacture_progress_sid = t1.day_manufacture_progress_sid
            WHERE t1.handle_status = '5'
            GROUP BY t.manufacture_order_process_sid
        ) t16 ON t.manufacture_order_process_sid = t16.manufacture_order_process_sid
                 LEFT JOIN (
            SELECT t.manufacture_order_sid , t2.plant_sid, SUM(t.quantity) as is_caichuang_quantity
            FROM s_man_day_manufacture_progress_item t
                     LEFT JOIN s_man_day_manufacture_progress t1 ON t.day_manufacture_progress_sid = t1.day_manufacture_progress_sid
                     LEFT JOIN s_man_manufacture_order_process t2 ON t.manufacture_order_process_sid = t2.manufacture_order_process_sid
            WHERE t1.handle_status = '5' AND t2.is_first_process = 'Y'
            GROUP BY t.manufacture_order_sid , t2.plant_sid
        ) t17 on t.manufacture_order_sid = t17.manufacture_order_sid and (t.plant_sid = t17.plant_sid or (t.plant_sid is null and t17.plant_sid is null))
    </sql>

    <select id="getItemList" parameterType="com.platform.ems.domain.ManManufactureOrderProcess"
            resultMap="ManManufactureOrderProcessResult">
        <if test="progressDimension == null and enterDimension!='K'.toString() or progressDimension == 'K'.toString()">
            <include refid="getItemListVo"/>
        </if>
        <if test="progressDimension == null and enterDimension=='K'.toString() and progressDimension != 'K'.toString()">
            <include refid="getItemKListVo"/>
        </if>
        <if test="progressDimension != null and progressDimension == 'K1'.toString() and enterDimension==null">
            <include refid="getSkuItemListVo"/>
        </if>
        <if test="progressDimension != null and progressDimension == 'K1'.toString() and enterDimension=='K1'.toString()">
            <include refid="getItemListK1Vo"/>
        </if>
        <where>
            <if test="manufactureOrderProcessSidList != null and manufactureOrderProcessSidList.length >0 ">
                and t.manufacture_order_process_sid in
                (<foreach collection="manufactureOrderProcessSidList" item="manufactureOrderProcessSid" separator=",">#{manufactureOrderProcessSid}</foreach>)
            </if>
            <if test="progressDimension != null and progressDimension == 'K1'.toString() and enterDimension==null">
                <if test="sku1SidList != null and sku1SidList.length >0 ">
                    and t2.sku1_sid in
                    (<foreach collection="sku1SidList" item="sku1Sid" separator=",">#{sku1Sid}</foreach>)
                </if>
            </if>
            <if test="manufactureOrderProcessSid != null">
                t.manufacture_order_process_sid = #{manufactureOrderProcessSid}
            </if>
            <if test="manufactureOrderCode != null">
                and t1.manufacture_order_code like concat('%',#{manufactureOrderCode}, '%')
            </if>
            <!--2022-10-12 wp 改排产批次号为精确查询-->
            <if test="paichanBatch != null and paichanBatch != ''">
                and t1.paichan_batch = #{paichanBatch}
            </if>
            <!--            <if test="paichanBatch != null and paichanBatch != ''">-->
            <!--                and t1.paichan_batch like concat('%',#{paichanBatch}, '%')-->
            <!--            </if>-->
            <if test="plantSid != null">
                and t.plant_sid = #{plantSid}
            </if>
            <if test="departmentSid != null">
                and t.department_sid = #{departmentSid}
            </if>
            <if test="departmentSidList != null and departmentSidList.length >0 ">
                and t.department_sid in
                (<foreach collection="departmentSidList" item="item" separator=",">#{item}</foreach>)
            </if>
            <if test="directorSidList != null and directorSidList.length >0 ">
                AND
                (<foreach collection="directorSidList" item="item" separator=" or ">
                t.director_sid like concat('%', #{item},'%')
            </foreach>)
            </if>
            <if test="departmentList != null and departmentList.length >0 ">
                and t.department_code in
                (<foreach collection="departmentList" item="item" separator=",">#{item}</foreach>)
            </if>
            <if test="plantSidList != null and plantSidList.length >0 ">
                and t.plant_sid in
                (<foreach collection="plantSidList" item="item" separator=",">#{item}</foreach>)
            </if>
            <if test="processSidList != null and processSidList.length >0 ">
                and t.process_sid in
                (<foreach collection="processSidList" item="processSid" separator=",">#{processSid}</foreach>)
            </if>
            <if test="materialCode != null and materialCode != ''">
                and (<foreach collection="materialCode.split(';')" item="materialCode" separator="or">t5.material_code
                like concat('%', #{materialCode}, '%')</foreach>)
            </if>
            <if test="isStageComplete != null and isStageComplete != ''">
                and t.is_stage_complete = #{isStageComplete}
            </if>
            <if test="endStatusList != null and endStatusList.length >0 ">
                and t.end_status in
                (<foreach collection="endStatusList" item="item" separator=",">#{item}</foreach>)
            </if>
            <if test="materialName != null and materialName != ''">
                and (<foreach collection="materialName.split(';')" item="materialName" separator="or">t1.material_name
                like concat('%', #{materialName}, '%')</foreach>)
            </if>
            <if test="isFirstProcess != null and isFirstProcess != ''">
                and t.is_first_process = #{isFirstProcess}
            </if>
            <if test="salesOrderCode != null and salesOrderCode != ''">
                and (<foreach collection="salesOrderCode.split(';')" item="item" separator="or">t1.sales_order_code like
                concat('%',#{item}, '%')</foreach>)
            </if>
            <if test="quantityReferProcessSid != null">
                and t.quantity_refer_process_sid = #{quantityReferProcessSid}
            </if>
            <if test="quantityReferProcessCode != null">
                and t.quantity_refer_process_code  like concat('%', #{quantityReferProcessCode}, '%')
            </if>
            <if test="quantityTypeReferProcess != null and quantityTypeReferProcess != ''">
                and t.quantity_type_refer_process = #{quantityTypeReferProcess}
            </if>
            <if test="customerSidList != null and customerSidList.length >0 ">
                and t2.customer_sid in
                (<foreach collection="customerSidList" item="customerSid" separator=",">#{customerSid}</foreach>)
            </if>
            <if test="productionModeList != null and productionModeList.length >0 ">
                and t.production_mode in
                (<foreach collection="productionModeList" item="productionMode" separator=",">
                #{productionMode}</foreach>)
            </if>
            <if test="productionMode != null and productionMode !=''">
                and t.production_mode =#{productionMode}
            </if>
            <if test="endFlag != null and endFlag != ''">
                and t.end_flag = #{endFlag}
            </if>
            <if test="handleStatusList != null and handleStatusList.length >0 ">
                and t1.handle_status in
                (<foreach collection="handleStatusList" item="handleStatus" separator=",">#{handleStatus}</foreach>)
            </if>
            <if test="handleStatus != null and handleStatus != ''">
                and t1.handle_status = #{handleStatus}
            </if>
            <if test="completeStatus != null and completeStatus != ''">
                and t1.complete_status = #{completeStatus}
            </if>
            <if test="completeStatusList != null and completeStatusList.length >0 ">
                and t1.complete_status in
                (<foreach collection="completeStatusList" item="completeStatus" separator=",">
                #{completeStatus}</foreach>)
            </if>
            <if test="planStartDateBegin != null and planStartDateBegin!=''">
                and date_format(t.plan_start_date,'%y%m%d') &gt;= date_format(#{planStartDateBegin},'%y%m%d')
            </if>
            <if test="planStartDateEnd != null and planStartDateEnd!=''">
                and date_format(t.plan_start_date,'%y%m%d') &lt;= date_format(#{planStartDateEnd},'%y%m%d')
            </if>
            <if test="planEndBeginDate != null and planEndBeginDate!=''">
                and date_format(t.plan_end_date,'%y%m%d') &gt;= date_format(#{planEndBeginDate},'%y%m%d')
            </if>
            <if test="planEndEndDate != null and planEndEndDate!=''">
                and date_format(t.plan_end_date,'%y%m%d') &lt;= date_format(#{planEndEndDate},'%y%m%d')
            </if>
            <if test="creatorAccount != null  and creatorAccount != ''">
                and (<foreach collection="creatorAccount.split(';')" item="item" separator="or">t13.nick_name like
                concat('%',#{item}, '%')</foreach>)
            </if>
            <if test="beginTime != null and beginTime!=''">and date_format(t.create_date,'%y%m%d') &gt;=
                date_format(#{beginTime},'%y%m%d')
            </if>
            <if test="endTime != null and endTime!=''">and date_format(t.create_date,'%y%m%d') &lt;=
                date_format(#{endTime},'%y%m%d')
            </if>
        </where>
        <if test="progressDimension != null and progressDimension == 'K1'.toString() and  enterDimension=='K1'.toString()">
            GROUP BY t.manufacture_order_process_sid,t31.sku1_sid
        </if>
        <if test="progressDimension != null and progressDimension == 'K1'.toString() and enterDimension==null">
            GROUP BY t.manufacture_order_sid,t2.material_sid,t2.sku1_sid,t.process_sid,t.process_batch_num
        </if>
        <if test="progressDimension == null">
            GROUP BY t.manufacture_order_process_sid
        </if>
        order by t1.manufacture_order_code desc, t.serial_num asc
    </select>

    <sql id="selectToexpireListSelectVo">
        SELECT t.manufacture_order_process_sid,t.client_id,t.manufacture_order_sid,t.manufacture_order_code,t.process_sid,
               t.process_name,t.work_center_sid,t.plant_sid,t.serial_num,t.production_mode,t.process_batch_num,t.is_stage_complete,
               t.picture_path, t.video_path, t1.complete_status, t1.plan_end_date as plan_end_date_head,
               t.is_produce_complete,t.is_first_process,t.start_flag,t.end_flag,t.quantity,t.current_complete_quantity,
               t.end_status,t.comment,t.cancel_flag,t.plan_start_date,t.actual_start_date,t.plan_end_date,t.actual_end_date,t.department_sid,
               t.department_code,t.item_num,t.quantity_refer_process_sid,t.quantity_refer_process_code,t.quantity_type_refer_process,
               t.milestone, t1.sku_sid, t11.sku_name,
               t.special_flag,
               t24.quantity as plan_total_quantity,
               t12.name as department_name,
               t.director_sid,t.director_code,t.is_produce_tg,t.plan_start_date_tg,t.actual_end_date_tg,t.is_produce_sp,
               t.plan_start_date_sp,t.actual_end_date_sp,t.remark,t.creator_account,t.create_date,t.updater_account,t.update_date,
               t.data_source_sys,t.manufacture_order_code, t1.material_sid, t1.material_code, t1.material_name, t1.paichan_batch,
               t2.user_id AS creator_account_id, t1.contract_date,
               IFNULL(t.toexpire_days_scdd_gx,IFNULL(t3.toexpire_days_scdd_gx,IFNULL(t4.toexpire_days_scdd_gx,7))) as toexpire_days_scdd_gx,
               IFNULL(t5.total_complete_quantity, 0) AS total_complete_quantity,
               (t.quantity - ifnull(t5.total_complete_quantity, 0)) as dai_quantity,
               IFNULL(t6.is_caichuang_quantity, 0) as is_caichuang_quantity,
               (IFNULL(t6.is_caichuang_quantity, 0) - IFNULL(t5.total_complete_quantity, 0)) AS dai_shicai_quantity,
               t7.plant_code, t7.plant_name, t7.short_name as plant_short_name, t8.work_center_code, t8.work_center_name, t9.staff_name as director_name
    </sql>

    <sql id="selectToexpireListFrom">
        FROM s_man_manufacture_order_process t
        LEFT JOIN s_man_manufacture_order t1 ON t.manufacture_order_sid = t1.manufacture_order_sid
        LEFT JOIN sys_user t2 ON t.creator_account = t2.user_name AND t.client_id = t2.client_id
        LEFT JOIN s_sys_default_setting_client t3 ON t.client_id = t3.client_id AND t3.handle_status = '5'
        LEFT JOIN s_sys_default_setting_system t4 ON t4.client_id = '10000'
        LEFT JOIN (
            SELECT t.manufacture_order_process_sid, SUM(t.quantity) as total_complete_quantity
            FROM s_man_day_manufacture_progress_item t
            LEFT JOIN s_man_day_manufacture_progress t1 ON t.day_manufacture_progress_sid = t1.day_manufacture_progress_sid
            WHERE t1.handle_status = '5'
            GROUP BY t.manufacture_order_process_sid
        ) t5 ON t.manufacture_order_process_sid = t5.manufacture_order_process_sid
        LEFT JOIN (
            SELECT t.manufacture_order_sid, t2.plant_sid, SUM(t.quantity) as is_caichuang_quantity
            FROM s_man_day_manufacture_progress_item t
            LEFT JOIN s_man_day_manufacture_progress t1 ON t.day_manufacture_progress_sid = t1.day_manufacture_progress_sid
            LEFT JOIN s_man_manufacture_order_process t2 ON t.manufacture_order_process_sid = t2.manufacture_order_process_sid
            WHERE t1.handle_status = '5' AND t2.is_first_process = 'Y'
            GROUP BY t.manufacture_order_sid, t2.plant_sid
        ) t6 ON t.manufacture_order_sid = t6.manufacture_order_sid and (t.plant_sid = t6.plant_sid or (t.plant_sid is null and t6.plant_sid is null))
        LEFT JOIN s_bas_plant t7 ON t.plant_sid = t7.plant_sid
        LEFT JOIN s_man_work_center t8 ON t.work_center_sid = t8.work_center_sid
        LEFT JOIN (
            SELECT ta.manufacture_order_process_sid,
                   GROUP_CONCAT(tb.staff_name ORDER BY tb.staff_name ASC SEPARATOR ';') as staff_name
            FROM s_man_manufacture_order_process ta
            LEFT JOIN s_bas_staff tb ON (ta.director_code = tb.staff_code
                or ta.director_code like concat('%;', tb.staff_code, ';%')
                or ta.director_code like concat(tb.staff_code, ';%')
                or ta.director_code like concat('%;', tb.staff_code))
            GROUP BY ta.manufacture_order_process_sid
        ) t9 ON t.manufacture_order_process_sid = t9.manufacture_order_process_sid
        LEFT JOIN s_bas_material t10 ON t1.material_sid = t10.material_sid
        LEFT JOIN s_bas_sku t11 ON t1.sku_sid = t11.sku_sid
        LEFT JOIN s_con_manufacture_department t12 ON t.department_sid = t12.sid
        LEFT JOIN (
            select manufacture_order_sid, sum(quantity) as quantity from s_man_manufacture_order_product group by manufacture_order_sid
        ) t24 ON t24.manufacture_order_sid = t.manufacture_order_sid
    </sql>

    <sql id="selectToexpireListWhere">
        <where>
            AND date_format(t.plan_end_date,'%y%m%d') &gt;= date_format(now(),'%y%m%d')
            AND date_format(t.plan_end_date,'%y%m%d') &lt;= date_format(date_add(now(), interval
            +IFNULL(t.toexpire_days_scdd_gx,IFNULL(t3.toexpire_days_scdd_gx,IFNULL(t4.toexpire_days_scdd_gx,7))) day),'%y%m%d')
            AND t1.handle_status = '5' AND t1.complete_status in ('WKS','JXZ') AND t.end_status in ('WKS','JXZ')
            <if test="clientId != null and clientId != ''">
                AND t.client_id = #{clientId}
            </if>
            <if test="handleStatus != null and handleStatus != ''">
                AND t1.handle_status = #{handleStatus}
            </if>
            <if test="endStatus != null and endStatus != ''">
                AND (t.end_status != #{endStatus} or t.end_status is null)
            </if>
            <if test="materialCode != null and materialCode != ''">
                and t10.material_code like concat('%', #{materialCode}, '%')
            </if>
            <if test="directorSidList != null and directorSidList.length >0 ">
                AND
                (<foreach collection="directorSidList" item="item" separator=" or ">
                t.director_sid like concat('%', #{item},'%')
            </foreach>)
            </if>
            <if test="plantSid != null">
                AND t.plant_sid = #{plantSid}
            </if>
            <if test="plantSidList != null and plantSidList.length >0 ">
                and t.plant_sid in (
                <foreach collection="plantSidList" item="plantSid" separator=",">#{plantSid}</foreach>)
            </if>
            <if test="processSid != null">
                AND t.process_sid = #{processSid}
            </if>
            <if test="processSidList != null and processSidList.length >0 ">
                and t.process_sid in (
                <foreach collection="processSidList" item="processSid" separator=",">#{processSid}</foreach>)
            </if>
            <if test="planEndDateBegin != null and planEndDateBegin!=''">and date_format(t.plan_end_date,'%y%m%d') &gt;=
                date_format(#{planEndDateBegin},'%y%m%d')
            </if>
            <if test="planEndDateEnd != null and planEndDateEnd!=''">and date_format(t.plan_end_date,'%y%m%d') &lt;=
                date_format(#{planEndDateEnd},'%y%m%d')
            </if>
        </where>
    </sql>

    <select id="selectToexpireList" parameterType="com.platform.ems.domain.ManManufactureOrderProcess"
            resultType="com.platform.ems.domain.ManManufactureOrderProcess">
        <if test="pageNum == null and pageSize != null">
            select count(0) as page_size
        </if>
        <if test="pageNum == null and pageSize == null">
            <include refid="selectToexpireListSelectVo"/>
        </if>
        <if test="pageNum != null and pageSize != null">
            <include refid="selectToexpireListSelectVo"/>
        </if>
        <include refid="selectToexpireListFrom"/>
        <include refid="selectToexpireListWhere"/>
        order by t.plan_end_date asc, CONVERT (t1.material_code USING gbk) asc, CONVERT (t.process_name USING gbk) asc
        <if test="pageNum != null and pageSize != null">LIMIT ${pageBegin},${pageSize}</if>
    </select>

    <sql id="selectOverdueListSelectVo">
        SELECT t.manufacture_order_process_sid,t.client_id,t.manufacture_order_sid,t.manufacture_order_code,t.process_sid,
               t.process_name,t.work_center_sid,t.plant_sid,t.serial_num,t.production_mode,t.process_batch_num,t.is_stage_complete,
               t.picture_path, t.video_path, t1.complete_status, t1.plan_end_date as plan_end_date_head,
               t.is_produce_complete,t.is_first_process,t.start_flag,t.end_flag,t.quantity,t.current_complete_quantity,
               (t.quantity - ifnull(t3.total_complete_quantity, 0)) as dai_quantity,
               (IFNULL(t4.is_caichuang_quantity, 0) - IFNULL(t3.total_complete_quantity, 0)) AS dai_shicai_quantity,
               t.end_status, t.comment,t.cancel_flag,t.plan_start_date,t.actual_start_date,t.plan_end_date,t.actual_end_date,t.department_sid,
               t.department_code,t.item_num,t.quantity_refer_process_sid,t.quantity_refer_process_code,t.quantity_type_refer_process,
               t.milestone,
               t.special_flag,
               t24.quantity as plan_total_quantity,
               t11.name as department_name,
               t.director_sid,t.director_code,t.is_produce_tg,t.plan_start_date_tg,t.actual_end_date_tg,t.is_produce_sp,
               t.plan_start_date_sp,t.actual_end_date_sp,t.remark,t.creator_account,t.create_date,t.updater_account,t.update_date,
               t.data_source_sys,t.manufacture_order_code,
               t1.sku_sid, t10.sku_name, t1.contract_date,
               t1.material_sid, t1.material_code, t1.material_name, t2.user_id AS creator_account_id,
               IFNULL(t3.total_complete_quantity, 0) AS total_complete_quantity, IFNULL(t4.is_caichuang_quantity, 0) as is_caichuang_quantity,
               t5.plant_code, t5.plant_name, t5.short_name as plant_short_name, t6.work_center_code, t6.work_center_name,
               t1.paichan_batch, t8.staff_name as director_name
    </sql>

    <sql id="selectOverdueListFrom">
        FROM s_man_manufacture_order_process t
        LEFT JOIN s_man_manufacture_order t1 ON t.manufacture_order_sid = t1.manufacture_order_sid
        LEFT JOIN sys_user t2 ON t.creator_account = t2.user_name AND t.client_id = t2.client_id
        LEFT JOIN (
            SELECT t.manufacture_order_process_sid, SUM(t.quantity) as total_complete_quantity
            FROM s_man_day_manufacture_progress_item t
            LEFT JOIN s_man_day_manufacture_progress t1 ON t.day_manufacture_progress_sid = t1.day_manufacture_progress_sid
            WHERE t1.handle_status = '5'
            GROUP BY t.manufacture_order_process_sid
        ) t3 ON t.manufacture_order_process_sid = t3.manufacture_order_process_sid
        LEFT JOIN (
            SELECT t.manufacture_order_sid, t2.plant_sid, SUM(t.quantity) as is_caichuang_quantity
            FROM s_man_day_manufacture_progress_item t
            LEFT JOIN s_man_day_manufacture_progress t1 ON t.day_manufacture_progress_sid = t1.day_manufacture_progress_sid
            LEFT JOIN s_man_manufacture_order_process t2 ON t.manufacture_order_process_sid = t2.manufacture_order_process_sid
            WHERE t1.handle_status = '5' AND t2.is_first_process = 'Y'
            GROUP BY t.manufacture_order_sid, t2.plant_sid
        ) t4 ON t.manufacture_order_sid = t4.manufacture_order_sid and (t.plant_sid = t4.plant_sid or (t.plant_sid is null and t4.plant_sid is null))
        LEFT JOIN s_bas_plant t5 ON t.plant_sid = t5.plant_sid
        LEFT JOIN s_man_work_center t6 ON t.work_center_sid = t6.work_center_sid
        LEFT JOIN s_man_process t7 ON t7.process_sid = t.process_sid
        LEFT JOIN (
            SELECT ta.manufacture_order_process_sid,
                   GROUP_CONCAT(tb.staff_name ORDER BY tb.staff_name ASC SEPARATOR ';') as staff_name
            FROM s_man_manufacture_order_process ta
            LEFT JOIN s_bas_staff tb ON (ta.director_code = tb.staff_code
                or ta.director_code like concat('%;', tb.staff_code, ';%')
                or ta.director_code like concat(tb.staff_code, ';%')
                or ta.director_code like concat('%;', tb.staff_code))
            GROUP BY ta.manufacture_order_process_sid
        ) t8 ON t.manufacture_order_process_sid = t8.manufacture_order_process_sid
        LEFT JOIN s_bas_material t9 ON t1.material_sid = t9.material_sid
        LEFT JOIN s_bas_sku t10 ON t1.sku_sid = t10.sku_sid
        LEFT JOIN s_con_manufacture_department t11 ON t.department_sid = t11.sid
        LEFT JOIN (
            select manufacture_order_sid, sum(quantity) as quantity from s_man_manufacture_order_product group by manufacture_order_sid
        ) t24 ON t24.manufacture_order_sid = t.manufacture_order_sid
    </sql>

    <sql id="selectOverdueListWhere">
        <where>
            AND date_format(t.plan_end_date,'%y%m%d') &lt; date_format(NOW(),'%y%m%d')
            AND t1.handle_status = '5' AND t1.complete_status in ('WKS','JXZ') AND t.end_status in ('WKS','JXZ')
            <if test="clientId != null and clientId != ''">
                AND t.client_id = #{clientId}
            </if>
            <if test="handleStatus != null and handleStatus != ''">
                AND t1.handle_status = #{handleStatus}
            </if>
            <if test="endStatus != null and endStatus != ''">
                AND (t.end_status != #{endStatus} or t.end_status is null)
            </if>
            <if test="materialCode != null and materialCode != ''">
                and t9.material_code like concat('%', #{materialCode}, '%')
            </if>
            <if test="directorSidList != null and directorSidList.length >0 ">
                AND
                (<foreach collection="directorSidList" item="item" separator=" or ">
                t.director_sid like concat('%', #{item},'%')
            </foreach>)
            </if>
            <if test="plantSid != null">
                AND t.plant_sid = #{plantSid}
            </if>
            <if test="plantSidList != null and plantSidList.length >0 ">
                and t.plant_sid in (
                <foreach collection="plantSidList" item="plantSid" separator=",">#{plantSid}</foreach>)
            </if>
            <if test="processSid != null">
                AND t.process_sid = #{processSid}
            </if>
            <if test="processSidList != null and processSidList.length >0 ">
                and t.process_sid in (
                <foreach collection="processSidList" item="processSid" separator=",">#{processSid}</foreach>)
            </if>
            <if test="planEndDateBegin != null and planEndDateBegin!=''">and date_format(t.plan_end_date,'%y%m%d') &gt;=
                date_format(#{planEndDateBegin},'%y%m%d')
            </if>
            <if test="planEndDateEnd != null and planEndDateEnd!=''">and date_format(t.plan_end_date,'%y%m%d') &lt;=
                date_format(#{planEndDateEnd},'%y%m%d')
            </if>
        </where>
    </sql>

    <select id="selectOverdueList" parameterType="com.platform.ems.domain.ManManufactureOrderProcess"
            resultType="com.platform.ems.domain.ManManufactureOrderProcess">
        <if test="pageNum == null and pageSize != null">
            select count(0) as page_size
        </if>
        <if test="pageNum == null and pageSize == null">
            <include refid="selectOverdueListSelectVo"/>
        </if>
        <if test="pageNum != null and pageSize != null">
            <include refid="selectOverdueListSelectVo"/>
        </if>
        <include refid="selectOverdueListFrom"/>
        <include refid="selectOverdueListWhere"/>
        order by t.plan_end_date asc, CONVERT (t1.material_code USING gbk) asc, CONVERT (t.process_name USING gbk) asc
        <if test="pageNum != null and pageSize != null">LIMIT ${pageBegin},${pageSize}</if>
    </select>

    <select id="selectManManufactureOrderProcessByProcessRouteList" parameterType="com.platform.ems.domain.ManManufactureOrderProcess"
            resultType="com.platform.ems.domain.ManManufactureOrderProcess">
        SELECT t.*, t2.process_code, t2.process_name, t3.serial_num AS serial_num, t3.serial_num AS serial_num_decimal,
        if(t.is_first_process = 'Y', (t1.quantity-t.total_complete_quantity), (t4.quantity-t.total_complete_quantity)) as not_complete_quantity
        FROM (
        SELECT t.manufacture_order_sid, t.process_sid, t.is_first_process, SUM(t1.quantity) AS total_complete_quantity, MAX(t.plan_end_date) AS plan_end_date
        FROM s_man_manufacture_order_process t
        LEFT JOIN (
        SELECT t.manufacture_order_process_sid, SUM(t.quantity) AS quantity
        FROM s_man_day_manufacture_progress_item t
        LEFT JOIN s_man_day_manufacture_progress t1 ON t.day_manufacture_progress_sid = t1.day_manufacture_progress_sid
        WHERE t1.handle_status = '5'
        GROUP BY t.manufacture_order_process_sid
        ) t1 ON t.manufacture_order_process_sid = t1.manufacture_order_process_sid
        <where>
            <if test="manufactureOrderSidList != null and manufactureOrderSidList.length >0 ">
                and t.manufacture_order_sid in
                (<foreach collection="manufactureOrderSidList" item="manufactureOrderSid" separator=",">
                #{manufactureOrderSid}</foreach>)
            </if>
            <if test="workCenterSidList != null and workCenterSidList.length >0 ">
                and t.work_center_sid in
                (<foreach collection="workCenterSidList" item="workCenterSid" separator=",">
                #{workCenterSid}</foreach>)
            </if>
            <if test="processSidList != null and processSidList.length >0 ">
                and t.process_sid in
                (<foreach collection="processSidList" item="processSid" separator=",">
                #{processSid}</foreach>)
            </if>
        </where>
        GROUP BY t.manufacture_order_sid, t.process_sid
        ) t
        LEFT JOIN (
        SELECT t.manufacture_order_sid, t.process_sid, SUM(t.quantity) AS quantity
        FROM s_man_manufacture_order_process t
        GROUP BY t.manufacture_order_sid,t.process_sid
        ) t1 ON t.manufacture_order_sid = t1.manufacture_order_sid AND t.process_sid = t1.process_sid
        LEFT JOIN s_man_process t2 ON t.process_sid = t2.process_sid
        LEFT JOIN s_man_process_route_item t3 ON t3.process_route_sid = #{processRouteSid} AND t.process_sid = t3.process_sid
        LEFT JOIN (
        SELECT t2.manufacture_order_sid,SUM(t.quantity) as quantity FROM (
        SELECT t.manufacture_order_process_sid, SUM(t.quantity) AS quantity
        FROM s_man_day_manufacture_progress_item t
        LEFT JOIN s_man_day_manufacture_progress t1 ON t.day_manufacture_progress_sid = t1.day_manufacture_progress_sid
        LEFT JOIN s_man_manufacture_order_process t2 ON t.manufacture_order_process_sid = t2.manufacture_order_process_sid
        WHERE t1.handle_status = '5' AND t2.is_first_process = 'Y'
        GROUP BY t.manufacture_order_process_sid
        ) t
        LEFT JOIN s_man_manufacture_order_process t2 ON t.manufacture_order_process_sid = t2.manufacture_order_process_sid
        GROUP BY t2.manufacture_order_sid
        ) t4 ON t.manufacture_order_sid = t4.manufacture_order_sid
    </select>

    <select id="selectByProcessRouteListGroupByWork" parameterType="com.platform.ems.domain.ManManufactureOrder"
            resultType="com.platform.ems.domain.ManManufactureOrderProcess">
        SELECT t.*, t2.plant_name, t2.short_name as plant_short_name, t3.work_center_code ,
        t3.work_center_name , t4.name as department_name, t6.name as unit_base_name
        FROM
        (
        SELECT t.manufacture_order_sid, t.work_center_sid, t.manufacture_order_code,
        t1.plant_sid, t1.material_sid, t1.material_code, t1.material_name, t1.paichan_batch,
        t1.plan_start_date, t1.plan_end_date, t1.quantity
        FROM s_man_manufacture_order_process t
        LEFT JOIN s_man_manufacture_order t1 ON t.manufacture_order_sid = t1.manufacture_order_sid
        <where>
            <if test="plantSid != null">
                and t.plant_sid =  #{plantSid}
            </if>
            <if test="plantSidList != null and plantSidList.length >0 ">
                and t.plant_sid in
                (<foreach collection="plantSidList" item="plantSid" separator=",">
                #{plantSid}</foreach>)
            </if>
            <if test="workCenterSid != null">
                and t.work_center_sid =  #{workCenterSid}
            </if>
            <if test="workCenterSidList != null and workCenterSidList.length >0 ">
                and t.work_center_sid in
                (<foreach collection="workCenterSidList" item="workCenterSid" separator=",">
                #{workCenterSid}</foreach>)
            </if>
            <if test="processSidList != null and processSidList.length >0 ">
                and t.process_sid in
                (<foreach collection="processSidList" item="processSid" separator=",">
                #{processSid}</foreach>)
            </if>
            <if test="materialCode != null and materialCode != ''">
                and t1.material_code like concat('%', #{materialCode}, '%')
            </if>
        </where>
        GROUP BY t.manufacture_order_sid, t.work_center_sid
        ) t
        LEFT JOIN s_bas_plant t2 ON t.plant_sid = t2.plant_sid
        LEFT JOIN s_man_work_center t3 ON t.work_center_sid = t3.work_center_sid
        LEFT JOIN s_con_manufacture_department t4 ON t3.department_sid = t4.sid
        LEFT JOIN s_bas_material t5 ON t.material_sid = t5.material_sid
        LEFT JOIN s_con_measure_unit t6 ON t5.unit_base = t6.code
        <if test="pageNum != null and pageSize != null">LIMIT ${pageBegin},${pageSize}</if>
    </select>

    <select id="selectByProcessRouteItemListGroupByWork" parameterType="com.platform.ems.domain.ManManufactureOrderProcess"
            resultType="com.platform.ems.domain.ManManufactureOrderProcess">
        SELECT t.manufacture_order_sid, t.work_center_sid, t.manufacture_order_code, t.process_sid,t.process_name,
        t.picture_path, t.video_path,
        t.plan_end_date, t.quantity as fenpei_quantity, t1.quantity as total_complete_quantity,
        t3.serial_num AS serial_num, t3.serial_num AS serial_num_decimal
        FROM s_man_manufacture_order_process t
        LEFT JOIN (
        SELECT t.manufacture_order_process_sid, SUM(t.quantity) AS quantity
        FROM s_man_day_manufacture_progress_item t
        LEFT JOIN s_man_day_manufacture_progress t1 ON t.day_manufacture_progress_sid = t1.day_manufacture_progress_sid
        WHERE t1.handle_status = '5'
        GROUP BY t.manufacture_order_process_sid
        ) t1 ON t.manufacture_order_process_sid = t1.manufacture_order_process_sid
        LEFT JOIN s_man_process_route_item t3 ON t3.process_route_sid = #{processRouteSid} AND t.process_sid = t3.process_sid
        <where>
            <if test="manufactureOrderSidList != null and manufactureOrderSidList.length >0 ">
                and t.manufacture_order_sid in
                (<foreach collection="manufactureOrderSidList" item="manufactureOrderSid" separator=",">
                #{manufactureOrderSid}</foreach>)
            </if>
            <if test="workCenterSidList != null and workCenterSidList.length >0 ">
                and t.work_center_sid in
                (<foreach collection="workCenterSidList" item="workCenterSid" separator=",">
                #{workCenterSid}</foreach>)
            </if>
            <if test="processSidList != null and processSidList.length >0 ">
                and t.process_sid in
                (<foreach collection="processSidList" item="processSid" separator=",">
                #{processSid}</foreach>)
            </if>
        </where>
    </select>


    <select id="selectManufactureOrderProcessTrackingList" parameterType="com.platform.ems.domain.dto.response.form.ManManuOrderProcessTracking"
            resultType="com.platform.ems.domain.dto.response.form.ManManuOrderProcessTracking">
        SELECT
        <if test="pageNum == null or pageSize == null">
            count(1) AS page_size
        </if>
        <if test="pageNum != null and pageSize != null">
            t.manufacture_order_process_sid,
            t.manufacture_order_sid,
            t.process_sid,
            t.plant_sid,
            t.quantity,
            t.end_status,
            t.picture_path,
            t.video_path,
            t.milestone,
            t.department_sid,t.department_code,
            t11.name as department_name,
            t.plan_start_date,
            t.plan_end_date,
            t.initial_plan_end_date,
            t.actual_start_date,
            t.actual_end_date,
            t.special_flag,
            t.is_first_process,
            t.is_stage_complete,
            t.is_produce_complete,
            t.serial_num,
            t.comment,
            t24.quantity as plan_total_quantity,
            t.director_sid,
            t1.manufacture_order_code,
            t1.contract_date,
            t1.material_sid,
            t1.material_code,
            t1.material_name,
            t1.sku_sid,
            t1.sku_code,
            t8.sku_name,
            t1.plant_sid as order_plant_sid,
            t1.paichan_batch,
            t1.complete_status,
            IFNULL(t.toexpire_days_scdd_gx,IFNULL(t9.toexpire_days_scdd_gx,IFNULL(t10.toexpire_days_scdd_gx,7))) as toexpire_days_scdd_gx,
            IF(t.end_status IN ('WKS','JXZ') AND t.plan_end_date &lt; DATE_FORMAT(NOW(), '%Y-%m-%d'),0,-1) as light,
            t2.total_complete_quantity,
            (t.quantity - ifnull(t2.total_complete_quantity, 0)) as dai_quantity,
            (IFNULL(t7.is_caichuang_quantity, 0) - IFNULL(t2.total_complete_quantity, 0)) AS dai_shicai_quantity,
            t3.process_name,
            t4.staff_code as director_code,
            t4.staff_name as director_name,
            IFNULL(t7.is_caichuang_quantity, 0) AS is_caichuang_quantity,
            t.work_center_sid,
            t12.work_center_code,
            t12.work_center_name,
            t1.plan_end_date as plan_end_date_head,
            t5.plant_code,
            t5.plant_name,
            IFNULL(t5.short_name,t5.plant_name) as plant_short_name,
            t6.plant_code as order_plant_code,
            t6.plant_name as order_plant_name,
            IFNULL(t6.short_name,t6.plant_name) as order_plant_short_name
        </if>
        FROM s_man_manufacture_order_process t
        LEFT JOIN s_man_manufacture_order t1 ON t.manufacture_order_sid = t1.manufacture_order_sid
        LEFT JOIN (
        SELECT t.manufacture_order_process_sid, SUM(t.quantity) as total_complete_quantity
        FROM s_man_day_manufacture_progress_item t
        LEFT JOIN s_man_day_manufacture_progress t1 ON t.day_manufacture_progress_sid = t1.day_manufacture_progress_sid
        WHERE t1.handle_status = '5'
        GROUP BY t.manufacture_order_process_sid
        ) t2 ON t.manufacture_order_process_sid = t2.manufacture_order_process_sid
        LEFT JOIN s_man_process t3 ON t.process_sid = t3.process_sid
        LEFT JOIN (
        SELECT ta.manufacture_order_process_sid,
        GROUP_CONCAT(tb.staff_code ORDER BY tb.staff_code ASC SEPARATOR ';') as staff_code,
        GROUP_CONCAT(tb.staff_name ORDER BY tb.staff_name ASC SEPARATOR ';') as staff_name
        FROM s_man_manufacture_order_process ta
        LEFT JOIN s_bas_staff tb ON (ta.director_code = tb.staff_code
        or ta.director_code like concat('%;', tb.staff_code, ';%')
        or ta.director_code like concat(tb.staff_code, ';%')
        or ta.director_code like concat('%;', tb.staff_code))
        GROUP BY ta.manufacture_order_process_sid
        ) t4 ON t.manufacture_order_process_sid = t4.manufacture_order_process_sid
        LEFT JOIN s_bas_plant t5 ON t.plant_sid = t5.plant_sid
        LEFT JOIN s_bas_plant t6 ON t1.plant_sid = t6.plant_sid
        LEFT JOIN (
        SELECT t.manufacture_order_sid, t2.plant_sid, SUM(t.quantity) as is_caichuang_quantity
        FROM s_man_day_manufacture_progress_item t
        LEFT JOIN s_man_day_manufacture_progress t1 ON t.day_manufacture_progress_sid = t1.day_manufacture_progress_sid
        LEFT JOIN s_man_manufacture_order_process t2 ON t.manufacture_order_process_sid = t2.manufacture_order_process_sid
        WHERE t1.handle_status = '5' AND t2.is_first_process = 'Y'
        GROUP BY t.manufacture_order_sid, t2.plant_sid
        ) t7 ON t.manufacture_order_sid = t7.manufacture_order_sid and (t.plant_sid = t7.plant_sid or (t.plant_sid is null and t7.plant_sid is null))
        LEFT JOIN s_bas_sku t8 ON t1.sku_sid = t8.sku_sid
        LEFT JOIN s_sys_default_setting_client t9 ON t.client_id = t9.client_id AND t9.handle_status = '5'
        LEFT JOIN s_sys_default_setting_system t10 ON t10.client_id = '10000'
        LEFT JOIN s_con_manufacture_department t11 ON t.department_sid = t11.sid
        LEFT JOIN s_man_work_center t12 ON t.work_center_sid = t12.work_center_sid
        LEFT JOIN (
        select manufacture_order_sid, sum(quantity) as quantity from s_man_manufacture_order_product group by manufacture_order_sid
        ) t24 ON t24.manufacture_order_sid = t.manufacture_order_sid
        <where>
            AND t1.handle_status = '5' AND t1.complete_status in ('WKS','JXZ')
            <if test="clientId != null and clientId != ''">
                AND t.client_id = #{clientId}
            </if>
            <if test="manufactureOrderProcessSid != null">
                AND t.manufacture_order_process_sid = #{manufactureOrderProcessSid}
            </if>
            <if test="manufactureOrderProcessSidList != null and manufactureOrderProcessSidList.length >0 ">
                AND t.manufacture_order_process_sid in
                (<foreach collection="manufactureOrderProcessSidList" item="item" separator=",">
                #{item}</foreach>)
            </if>
            <if test="manufactureOrderSid != null">
                AND t.manufacture_order_sid = #{manufactureOrderSid}
            </if>
            <if test="manufactureOrderSidList != null and manufactureOrderSidList.length >0 ">
                AND t.manufacture_order_sid in
                (<foreach collection="manufactureOrderSidList" item="item" separator=",">
                #{item}</foreach>)
            </if>
            <if test="processSid != null">
                AND t.process_sid = #{processSid}
            </if>
            <if test="processSidList != null and processSidList.length >0 ">
                AND t.process_sid in
                (<foreach collection="processSidList" item="item" separator=",">
                #{item}</foreach>)
            </if>
            <if test="directorSid != null">
                AND t.director_sid = #{directorSid}
            </if>
            <if test="directorSidList != null and directorSidList.length >0 ">
                AND
                (<foreach collection="directorSidList" item="item" separator=" or ">
                t.director_sid like concat('%', #{item},'%')
            </foreach>)
            </if>
            <if test="plantSid != null">
                AND t.plant_sid = #{plantSid}
            </if>
            <if test="plantSidList != null and plantSidList.length >0 ">
                AND t.plant_sid in
                (<foreach collection="plantSidList" item="item" separator=",">
                #{item}</foreach>)
            </if>
            <if test="planEndDateBegin != null and planEndDateBegin!=''">
                and date_format(t.plan_end_date,'%y%m%d') &gt;= date_format(#{planEndDateBegin},'%y%m%d')
            </if>
            <if test="planEndDateEnd != null and planEndDateEnd!=''">
                and date_format(t.plan_end_date,'%y%m%d') &lt;= date_format(#{planEndDateEnd},'%y%m%d')
            </if>
            <if test="endStatus != null and endStatus != ''">
                AND t.end_status = #{endStatus}
            </if>
            <if test="endStatusList != null and endStatusList.length >0 ">
                AND t.end_status in
                (<foreach collection="endStatusList" item="item" separator=",">
                #{item}</foreach>)
            </if>
            <if test="materialCode != null and materialCode != ''">
                AND t1.material_code like concat('%',#{materialCode},'%')
            </if>
            <if test="completeStatus != null and completeStatus != ''">
                AND t1.complete_status = #{completeStatus}
            </if>
            <if test="completeStatusList != null and completeStatusList.length >0 ">
                AND t1.complete_status in
                (<foreach collection="completeStatusList" item="item" separator=",">
                #{item}</foreach>)
            </if>
        </where>
        <if test="pageNum != null and pageSize != null">
            ORDER BY light DESC, t.plan_end_date ASC, CONVERT (t4.staff_name USING gbk) ASC, CONVERT (t.process_name USING gbk) ASC
            LIMIT ${pageBegin},${pageSize}
        </if>
    </select>
</mapper>
