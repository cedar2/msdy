<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.platform.system.mapper.SysUserMapper">

    <resultMap type="com.platform.common.core.domain.entity.SysUser" id="SysUserResult">
		<id property="userId" column="user_id"/>
		<result property="deptId" column="dept_id"/>
		<result property="userName" column="user_name"/>
		<result property="nickName" column="nick_name"/>
		<result property="email" column="email"/>
		<result property="phonenumber" column="phonenumber"/>
		<result property="sex" column="sex"/>
		<result property="avatar" column="avatar"/>
		<result property="password" column="password"/>
		<result property="status" column="status"/>
		<result property="delFlag" column="del_flag"/>
		<result property="loginIp" column="login_ip"/>
		<result property="loginDate" column="login_date"/>
		<result property="createBy" column="create_by"/>
		<result property="createTime" column="create_time"/>
		<result property="updateBy" column="update_by"/>
		<result property="updateTime" column="update_time"/>
		<result property="remark" column="remark"/>
		<result property="clientId" column="client_id"/>
		<result property="workWechatOpenid" column="work_wechat_openid"/>
		<result property="wechatOpenid" column="wechat_openid"/>
		<result property="dingtalkOpenid" column="dingtalk_openid"/>
		<result property="wxGzhOpenid" column="wx_gzh_openid"/>
		<result property="workWechatFlag" column="work_wechat_flag"/>
		<result property="wxGzhFlag" column="wx_gzh_flag"/>
		<result property="wxXcxFlag" column="wx_xcx_flag"/>
		<result property="dingtalkFlag" column="dingtalk_flag"/>
		<result property="isAdministrator" column="is_administrator"/>
		<result property="accountType" column="account_type"/>
		<result property="vendorSid" column="vendor_sid"/>
		<result property="createByName" column="create_by_name" />
		<result property="vendorShortName" column="vendor_short_name"/>
		<result property="customerSid" column="customer_sid"/>
		<result property="clientType" column="client_type"/>
		<result property="industryField" column="industry_field"/>
		<result property="staffSid" column="staff_sid"/>
		<result property="isBusinessFinance" column="is_business_finance"/>
		<result property="isPandianApproval" column="is_pandian_approval"/>
		<result property="erpMaterialSkuEnterModeProject" column="erp_material_sku_enter_mode_project"/>
		<result property="productCodeEnterModeProject" column="product_code_enter_mode_project"/>
		<result property="userType" column="user_type"/>
		<result property="vendorName" column="vendor_name"/>
		<result property="staffName" column="staff_name"/>
		<result property="customerName" column="customer_name"/>
		<result property="logonTimeout" column="logon_timeout"/>
		<result property="workWechatOpenid" column="work_wechat_openid"/>
		<result property="dingtalkOpenid" column="dingtalk_openid"/>
		<result property="feishuOpenId" column="feishu_open_id"/>
		<result property="wxGzhOpenid" column="wx_gzh_openid"/>
		<result property="jiandaoyunUsername" column="jiandaoyun_username"/>
		<association property="dept" column="dept_id" javaType="com.platform.common.core.domain.entity.SysDept"
					 resultMap="deptResult"/>
		<association property="client" column="client_id" javaType="com.platform.common.core.domain.entity.SysDefaultSettingClient"
					 resultMap="clientResult"/>
		<collection property="roles" javaType="java.util.List" resultMap="RoleResult"/>
    </resultMap>

    <resultMap id="deptResult" type="com.platform.common.core.domain.entity.SysDept">
        <id     property="deptId"    column="dept_id"     />
        <result property="parentId"  column="parent_id"   />
        <result property="deptName"  column="dept_name"   />
        <result property="ancestors" column="ancestors"   />
        <result property="orderNum"  column="order_num"   />
        <result property="leader"    column="leader"      />
        <result property="status"    column="dept_status" />
    </resultMap>

    <resultMap id="RoleResult" type="com.platform.common.core.domain.entity.SysRole">
        <id     property="roleId"       column="role_id"        />
        <result property="roleName"     column="role_name"      />
        <result property="roleKey"      column="role_key"       />
        <result property="roleSort"     column="role_sort"      />
        <result property="dataScope"    column="data_scope"     />
        <result property="status"       column="role_status"    />
    </resultMap>

	<resultMap id="clientResult" type="com.platform.common.core.domain.entity.SysDefaultSettingClient">
		<id property="clientId" column="client_id"/>
		<result property="productSeasonYanfa" column="product_season_yanfa"/>
		<result property="productSeasonCaigou" column="product_season_caigou"/>
		<result property="productSeasonXiaoshou" column="product_season_xiaoshou"/>
		<result property="productSeasonShengchan" column="product_season_shengchan"/>
		<result property="isAutodisplayPriceInStockOther" column="is_autodisplay_price_in_stock_other"/>
		<result property="isAutodisplayPriceOutStockOther" column="is_autodisplay_price_out_stock_other"/>
		<result property="isPandianApproval" column="is_pandian_approval"/>
		<result property="vendorEnterRequestInStockOther" column="vendor_enter_request_in_stock_other"/>
		<result property="customerEnterRequestInStockOther" column="customer_enter_request_in_stock_other"/>
		<result property="vendorEnterRequestOutStockOther" column="vendor_enter_request_out_stock_other"/>
		<result property="customerEnterRequestOutStockOther" column="customer_enter_request_out_stock_other"/>
		<result property="priceEnterRequestInStockOther" column="price_enter_request_in_stock_other"/>
		<result property="priceEnterRequestOutStockOther" column="price_enter_request_out_stock_other"/>
		<result property="erpMaterialSkuEnterModeProject" column="erp_material_sku_enter_mode_project"/>
		<result property="productCodeEnterModeProject" column="product_code_enter_mode_project"/>
		<result property="purchaseOrderContractEnterMode" column="purchase_order_contract_enter_mode"/>
		<result property="saleOrderContractEnterMode" column="sale_order_contract_enter_mode"/>
		<result property="manOutsourceSettleContractEnterMode" column="man_outsource_settle_contract_enter_mode"/>
		<result property="isInDefectivePriceTaxEqualToPriceTax" column="is_in_defective_price_tax_equal_to_price_tax"/>
		<result property="logonTimeout" column="logon_timeout"/>
		<result property="toexpireDaysCght" column="toexpire_days_cght"/>
		<result property="toexpireDaysCgdd" column="toexpire_days_cgdd"/>
		<result property="toexpireDaysXsht" column="toexpire_days_xsht"/>
		<result property="toexpireDaysXsdd" column="toexpire_days_xsdd"/>
		<result property="toexpireDaysScdd" column="toexpire_days_scdd"/>
		<result property="toexpireDaysScddGx" column="toexpire_days_scdd_gx"/>
		<result property="toexpireDaysScddSp" column="toexpire_days_scdd_sp"/>
		<result property="toexpireDaysScddSx" column="toexpire_days_scdd_sx"/>
		<result property="toexpireDaysProject" column="toexpire_days_project"/>
		<result property="toexecuteNoticeDaysPrjTask" column="toexecute_notice_days_prj_task"/>
		<result property="noticeTypePreTaskIncomplete" column="notice_type_pre_task_incomplete"/>
		<result property="noticeTypePurRequireToOrderExcess" column="notice_type_pur_require_to_order_excess"/>
		<result property="isSalePriceAssociateCustomer" column="is_sale_price_associate_customer"/>
		<result property="isRequiredProductSeasonProduct" column="is_required_product_season_product"/>
		<result property="isRequiredUpDownSuitProduct" column="is_required_up_down_suit_product"/>
		<result property="isRequiredModelProduct" column="is_required_model_product"/>
		<result property="isRequiredProductTechniqueTypeProduct" column="is_required_product_technique_type_product"/>
		<result property="isRequiredSku2GroupProduct" column="is_required_sku2_group_product"/>
		<result property="isRequiredVendorMaterial" column="is_required_vendor_material"/>
		<result property="isRequiredUnitQuantityMaterial" column="is_required_unit_quantity_material"/>
		<result property="isRequiredQuotePriceTaxMaterial" column="is_required_quote_price_tax_material"/>
		<result property="isRequiredPurchaseOrderContract" column="is_required_purchase_order_contract"/>
		<result property="isRequiredSaleOrderContract" column="is_required_sale_order_contract"/>
		<result property="isProductContractDateIdentical" column="is_product_contract_date_identical"/>
		<result property="isProcessWorkCenterEditable" column="is_process_work_center_editable"/>
		<result property="quotePriceAssociateDimensionPurchasePrice" column="quote_price_associate_dimension_purchase_price"/>
		<result property="isRequiredMaterialTypeGysdzd" column="is_required_material_type_gysdzd"/>
		<result property="isQueryOtherUser" column="is_query_other_user"/>
		<result property="isXiefuIndustry" column="is_xiefu_industry"/>
	</resultMap>

	<sql id="selectUserVo">
		SELECT
			u.user_id,
			u.dept_id,
			u.user_name,
			u.nick_name,
			u.email,
			u.avatar,
			u.phonenumber,
			u.PASSWORD,
			u.sex,
			u.STATUS,
			u.del_flag,
			u.login_ip,
			u.login_date,
			u.create_by,
			u.create_time,
			u.remark,
			u.client_id,
			u.vendor_sid,
			u.customer_sid,
			u.staff_sid,
			u.account_type,
			u.user_type,
			ifnull(u.work_wechat_flag,'0') as work_wechat_flag,
			ifnull(u.wx_gzh_flag,'0') as wx_gzh_flag,
			ifnull(u.wx_xcx_flag,'0') as wx_xcx_flag,
			ifnull(u.dingtalk_flag,'0') as dingtalk_flag,
			d.dept_id,
			d.parent_id,
			d.dept_name,
			d.order_num,
			d.leader,
			d.STATUS AS dept_status,
			r.role_id,
			r.role_name,
			r.role_key,
			r.role_sort,
			r.data_scope,
			r.STATUS AS role_status,
			u.work_wechat_openid,
			u.wechat_openid,
			u.dingtalk_openid,
			u.wx_gzh_openid,
			u.is_administrator,
			t1.customer_name,
			t2.staff_code,
			t2.staff_name,
			t3.vendor_code,
			t3.vendor_name,
			t3.short_name,
			t3.short_name as vendor_short_name,
			t4.client_type,
			t4.industry_field,
			t4.is_business_finance,
			ifnull(t6.logon_timeout,t5.logon_timeout) as logon_timeout,
			t6.is_pandian_approval,
			t6.vendor_enter_request_in_stock_other,
			t6.customer_enter_request_in_stock_other,
			t6.vendor_enter_request_out_stock_other,
			t6.customer_enter_request_out_stock_other,
			t6.price_enter_request_in_stock_other,
			t6.price_enter_request_out_stock_other,
			t6.erp_material_sku_enter_mode_project,
			t6.product_code_enter_mode_project,
			t6.purchase_order_contract_enter_mode,
			t6.sale_order_contract_enter_mode,
			t6.man_outsource_settle_contract_enter_mode,
			t6.toexecute_notice_days_prj_task,
			t6.notice_type_pre_task_incomplete,
			t6.notice_type_pur_require_to_order_excess,
			t6.is_sale_price_associate_customer,
			t6.is_required_product_season_product,
			t6.is_required_up_down_suit_product,
			t6.is_required_model_product,
			t6.is_required_product_technique_type_product,
			t6.is_required_sku2_group_product,
			t6.is_required_vendor_material,
			t6.is_required_unit_quantity_material,
			t6.is_required_quote_price_tax_material,
			t6.is_in_defective_price_tax_equal_to_price_tax,
			t6.is_required_purchase_order_contract,
			t6.is_required_sale_order_contract,
			t6.is_product_contract_date_identical,
			t6.is_process_work_center_editable,
		    t6.quote_price_associate_dimension_purchase_price,
		    t6.is_required_material_type_gysdzd,
			t6.is_query_other_user,
			t6.is_xiefu_industry,
			u.work_wechat_openid,
			u.dingtalk_openid,
			u.feishu_open_id,
			u.wx_gzh_openid,
			u.jiandaoyun_username
		FROM
			sys_user u
		LEFT JOIN sys_dept d ON u.dept_id = d.dept_id
		LEFT JOIN sys_user_role ur ON u.user_id = ur.user_id
		LEFT JOIN sys_role r ON r.role_id = ur.role_id
		LEFT JOIN s_bas_customer t1 ON t1.customer_sid = u.customer_sid
		LEFT JOIN s_bas_staff t2 ON t2.staff_sid = u.staff_sid
		LEFT JOIN s_bas_vendor t3 ON t3.vendor_sid = u.vendor_sid
		left join s_sys_client t4 on t4.client_id=u.client_id
		Left join s_sys_default_setting_system t5 on t5.client_id='10000'
		Left join s_sys_default_setting_client t6 on u.client_id = t6.client_id
    </sql>

    <select id="selectUserList" parameterType="com.platform.common.core.domain.entity.SysUser" resultMap="SysUserResult">
		select t.nick_name as create_by_name , u.user_id, u.dept_id, u.nick_name, u.user_name, u.email, u.avatar,
		u.phonenumber, u.password, u.sex, u.account_type,	u.user_type, u.vendor_sid, u.customer_sid, u.staff_sid,
		u.status, u.del_flag, u.login_ip, u.login_date, u.create_by, u.create_time, u.remark,u.client_id, d.dept_name,
		u.work_wechat_openid,u.dingtalk_openid,u.feishu_open_id,u.wx_gzh_openid,
		ifnull(u.work_wechat_flag,'0') as work_wechat_flag,
		ifnull(u.wx_gzh_flag,'0') as wx_gzh_flag,
		ifnull(u.wx_xcx_flag,'0') as wx_xcx_flag,
		ifnull(u.dingtalk_flag,'0') as dingtalk_flag,
		v.short_name as vendor_name , s.staff_name as staff_name , c.short_name as customer_name,
		d.leader from sys_user u
		left join sys_dept d on u.dept_id = d.dept_id
		left join s_bas_vendor v on u.vendor_sid = v.vendor_sid
		left join s_bas_staff s on u.staff_sid = s.staff_sid
		left join s_bas_customer c on u.customer_sid = c.customer_sid
		left join sys_user t on u.create_by = t.user_name
		<where>
			<if test="userId != null and userId != ''">
				AND u.user_id = #{userId}
			</if>
			<if test="nickUserName != null and nickUserName != ''">
				and (u.user_name like concat('%', #{nickUserName}, '%')
				or u.nick_name like concat('%', #{nickUserName}, '%'))
			</if>
			<if test="clientId != null and clientId != ''">
				AND u.client_id = #{clientId}
			</if>
			<if test="userName != null and userName != ''">
				AND u.user_name like concat('%', #{userName}, '%')
			</if>
			<if test="nickName != null and nickName != ''">
				AND u.nick_name like concat('%', #{nickName}, '%')
			</if>
			<if test="status != null and status != ''">
				AND u.status = #{status}
			</if>
			<if test="userType != null and userType != ''">
				AND u.user_type = #{userType}
			</if>
			<if test="delFlag != null and delFlag != ''">
				AND u.del_flag = #{delFlag}
			</if>
			<if test="accountTypeArray != null and accountTypeArray.length > 0">
				AND u.account_type in (
				<foreach collection="accountTypeArray" item="item" separator=",">
					#{item}
				</foreach>
				)
			</if>
			<if test="vendorSid != null ">
				and u.vendor_sid =#{vendorSid}
			</if>
			<if test="customerSid != null ">
				and u.customer_sid =#{customerSid}
			</if>
			<if test="staffSid != null ">
				and u.staff_sid =#{staffSid}
			</if>
			<if test="phonenumber != null and phonenumber != ''">
				AND u.phonenumber like concat('%', #{phonenumber}, '%')
			</if>
			<if test="email != null and email != ''">
				AND u.email = #{email}
			</if>
			<if test="createBy != null and createBy != ''">
				AND u.create_by = #{createBy}
			</if>
			<if test="beginTime != null and beginTime != ''"><!-- 开始时间检索 -->
				AND date_format(u.create_time,'%y%m%d') &gt;= date_format(#{beginTime},'%y%m%d')
			</if>
			<if test="endTime != null and endTime != ''"><!-- 结束时间检索 -->
				AND date_format(u.create_time,'%y%m%d') &lt;= date_format(#{endTime},'%y%m%d')
			</if>
			<if test="deptId != null and deptId != 0">
				AND (u.dept_id = #{deptId} OR u.dept_id IN ( SELECT t.dept_id FROM sys_dept t WHERE find_in_set(#{deptId},
				ancestors) ))
			</if>
			<!-- 数据范围过滤 -->
			${params.dataScope}
		</where>
	</select>

	<select id="selectAllocatedList" parameterType="com.platform.common.core.domain.entity.SysUser" resultMap="SysUserResult">
	    select distinct u.user_id, u.dept_id, u.user_name, u.nick_name, u.email, u.phonenumber, u.status, u.create_time
	    from sys_user u
			 left join sys_dept d on u.dept_id = d.dept_id
			 left join sys_user_role ur on u.user_id = ur.user_id
			 left join sys_role r on r.role_id = ur.role_id
	    where u.del_flag = '0' and r.role_id = #{roleId}
	    <if test="userName != null and userName != ''">
			AND u.user_name like concat('%', #{userName}, '%')
		</if>
		<if test="phonenumber != null and phonenumber != ''">
			AND u.phonenumber like concat('%', #{phonenumber}, '%')
		</if>
		<!-- 数据范围过滤 -->
		${params.dataScope}
	</select>

	<select id="selectUnallocatedList" parameterType="com.platform.common.core.domain.entity.SysUser" resultMap="SysUserResult">
	    select distinct u.user_id, u.dept_id, u.user_name, u.nick_name, u.email, u.phonenumber, u.status, u.create_time
	    from sys_user u
			 left join sys_dept d on u.dept_id = d.dept_id
			 left join sys_user_role ur on u.user_id = ur.user_id
			 left join sys_role r on r.role_id = ur.role_id
	    where u.del_flag = '0' and (r.role_id != #{roleId} or r.role_id IS NULL)
	    and u.user_id not in (select u.user_id from sys_user u inner join sys_user_role ur on u.user_id = ur.user_id and ur.role_id = #{roleId})
	    <if test="userName != null and userName != ''">
			AND u.user_name like concat('%', #{userName}, '%')
		</if>
		<if test="phonenumber != null and phonenumber != ''">
			AND u.phonenumber like concat('%', #{phonenumber}, '%')
		</if>
		<!-- 数据范围过滤 -->
		${params.dataScope}
	</select>

	<update id="updateUserStatus">
		<if test="userId != null and status != null and status != ''">
			update sys_user
			set status = #{status}
			where user_id = #{userId}
		</if>
	</update>

	<select id="selectUserByUserName" parameterType="String" resultMap="SysUserResult">
	    <include refid="selectUserVo"/>
		where u.user_name = #{userName} and u.del_flag = '0'
	</select>

	<select id="selectUserById" parameterType="Long" resultMap="SysUserResult">
		<include refid="selectUserVo"/>
		where u.user_id = #{userId}
	</select>

	<select id="checkUserNameUnique" parameterType="String" resultMap="SysUserResult">
		select user_id, user_name from sys_user where user_name = #{userName} and del_flag = '0' limit 1
	</select>

	<select id="checkPhoneUnique" parameterType="String" resultMap="SysUserResult">
		select user_id, phonenumber from sys_user where phonenumber = #{phonenumber} and del_flag = '0' limit 1
	</select>

	<select id="checkEmailUnique" parameterType="String" resultMap="SysUserResult">
		select user_id, email from sys_user where email = #{email} and del_flag = '0' limit 1
	</select>

	<insert id="insertUser" parameterType="com.platform.common.core.domain.entity.SysUser" useGeneratedKeys="true" keyProperty="userId">
 		insert into sys_user(
 			<if test="userId != null and userId != 0">user_id,</if>
 			<if test="deptId != null and deptId != 0">dept_id,</if>
 			<if test="userName != null and userName != ''">user_name,</if>
 			<if test="nickName != null and nickName != ''">nick_name,</if>
 			<if test="email != null and email != ''">email,</if>
 			<if test="avatar != null and avatar != ''">avatar,</if>
 			<if test="phonenumber != null and phonenumber != ''">phonenumber,</if>
 			<if test="sex != null and sex != ''">sex,</if>
 			<if test="password != null and password != ''">password,</if>
 			<if test="status != null and status != ''">status,</if>
 			<if test="createBy != null and createBy != ''">create_by,</if>
 			<if test="remark != null and remark != ''">remark,</if>
 			create_time
 		)values(
 			<if test="userId != null and userId != ''">#{userId},</if>
 			<if test="deptId != null and deptId != ''">#{deptId},</if>
 			<if test="userName != null and userName != ''">#{userName},</if>
 			<if test="nickName != null and nickName != ''">#{nickName},</if>
 			<if test="email != null and email != ''">#{email},</if>
 			<if test="avatar != null and avatar != ''">#{avatar},</if>
 			<if test="phonenumber != null and phonenumber != ''">#{phonenumber},</if>
 			<if test="sex != null and sex != ''">#{sex},</if>
 			<if test="password != null and password != ''">#{password},</if>
 			<if test="status != null and status != ''">#{status},</if>
 			<if test="createBy != null and createBy != ''">#{createBy},</if>
 			<if test="remark != null and remark != ''">#{remark},</if>
 			sysdate()
 		)
	</insert>

	<update id="updateUser" parameterType="com.platform.common.core.domain.entity.SysUser">
 		update sys_user
 		<set>
 			<if test="deptId != null and deptId != 0">dept_id = #{deptId},</if>
 			<if test="userName != null and userName != ''">user_name = #{userName},</if>
 			<if test="nickName != null and nickName != ''">nick_name = #{nickName},</if>
 			<if test="email != null ">email = #{email},</if>
 			<if test="phonenumber != null ">phonenumber = #{phonenumber},</if>
 			<if test="sex != null and sex != ''">sex = #{sex},</if>
 			<if test="avatar != null and avatar != ''">avatar = #{avatar},</if>
 			<if test="password != null and password != ''">password = #{password},</if>
 			<if test="status != null and status != ''">status = #{status},</if>
 			<if test="loginIp != null and loginIp != ''">login_ip = #{loginIp},</if>
 			<if test="loginDate != null">login_date = #{loginDate},</if>
 			<if test="updateBy != null and updateBy != ''">update_by = #{updateBy},</if>
 			<if test="remark != null">remark = #{remark},</if>
 			update_time = sysdate()
 		</set>
 		where user_id = #{userId}
	</update>

	<update id="updateUserAvatar" parameterType="com.platform.common.core.domain.entity.SysUser">
 		update sys_user set avatar = #{avatar} where user_name = #{userName}
	</update>

	<update id="resetUserPwd" parameterType="com.platform.common.core.domain.entity.SysUser">
 		update sys_user set password = #{password} where user_name = #{userName}
	</update>

	<delete id="deleteUserById" parameterType="Long">
 		update sys_user set del_flag = '2' where user_id = #{userId}
 	</delete>

 	<delete id="deleteUserByIds" parameterType="Long">
 		update sys_user set del_flag = '2' where user_id in
 		<foreach collection="array" item="userId" open="(" separator="," close=")">
 			#{userId}
        </foreach>
 	</delete>

	<select id="selectUserByNameAndId" resultMap="SysUserResult">
		<include refid="selectUserVo"/>
		where u.user_name = #{userName} and u.client_id=#{clientId}
	</select>

	<resultMap type="com.platform.common.core.domain.model.SysRoleDataAuthFieldValue" id="authFieldValueResult">
		<result property="fieldName" column="field_name"/>
		<result property="fieldCode" column="field_code"/>
		<result property="authorityFieldParam" column="authority_field_param"/>
		<result property="authorityFieldValue" column="authority_field_value"/>
		<result property="objectName" column="object_name"/>
		<result property="objectCode" column="object_code"/>
		<result property="roleDataName" column="role_data_name"/>
		<result property="roleDataCode" column="role_data_code"/>
	</resultMap>

	<select id="selectRoleDataAuthFiledValueList" resultMap="authFieldValueResult">
		select t.client_id,
			   t.data_role_authority_field_value_sid,
			   t.data_role_authority_object_sid,
			   t.authority_object_field_sid,
			   t.authority_field_value,
			   t.remark,
			   t1.role_data_sid,
			   t2.authority_object_sid,
			   t2.authority_field_sid,
			   t2.authority_field_param,
			   t3.object_code,
			   t3.object_name,
			   t4.field_code,
			   t4.field_name,
			   t5.role_data_code,
			   t5.role_data_name
		from s_sys_data_role_authority_field_value t
				 left join s_sys_data_role_authority_object t1 on t.data_role_authority_object_sid = t1.data_role_authority_object_sid
				 left join s_sys_authority_object_field t2 on t.authority_object_field_sid = t2.authority_object_field_sid
				 left join s_sys_authority_object t3 on t2.authority_object_sid = t3.authority_object_sid
				 left join s_sys_authority_field t4 on t2.authority_field_sid = t4.authority_field_sid
				 left join sys_role_data t5 on t1.role_data_sid = t5.role_data_sid
		WHERE t4.category = 'SHUJ' AND t4.handle_status = '5' AND t4.status = '1'
		  AND t3.category = 'SHUJ' AND t3.handle_status = '5' AND t3.status = '1'
		  AND t5.role_category = 'SJ' AND t5.handle_status = '5' AND t5.status = '1'
		  AND t5.role_data_sid IN (SELECT role_data_sid FROM s_sys_user_data_role WHERE user_id = #{userId})
	</select>


	<select id="selectUserByOpenid" parameterType="String" resultMap="SysUserResult">
		<include refid="selectUserVo"/>
		where u.wechat_openid = #{openId}
	</select>

	<select id="selectUserByqyUserId" parameterType="String" resultMap="SysUserResult">
		<include refid="selectUserVo"/>
		where u.work_wechat_openid = #{workWechatOpenid}
	</select>

	<select id="selectUserBydingtalk" parameterType="String" resultMap="SysUserResult">
		<include refid="selectUserVo"/>
		where u.dingtalk_openid = #{userId}
	</select>

	<select id="selectUserByGzhOpenId" parameterType="String" resultMap="SysUserResult">
		<include refid="selectUserVo"/>
		where u.wx_gzh_openid = #{gzhOpenId}
	</select>

	<select id="checkUserTypeUnique" parameterType="com.platform.common.core.domain.entity.SysUser" resultMap="SysUserResult">
		select user_id,client_id,user_type from sys_user where user_type = #{userType} and client_id=#{clientId}
	</select>

	<update id="cnacel">
		update sys_user
		<set>
			<if test="type == '1'.toString()">dingtalk_flag = #{dingtalkFlag},dingtalk_openid=null,</if>
			<if test="type == '2'.toString()">work_wechat_flag = #{workWechatFlag},work_wechat_openid=null,</if>
			<if test="type == '3'.toString()">wx_gzh_flag = #{wxGzhFlag},wx_gzh_openid = null,</if>
			update_time = sysdate()
		</set>
		where user_id = #{userId}
	</update>

	<update id="updateUserOpenId" parameterType="com.platform.common.core.domain.entity.SysUser">
		update sys_user
		<trim prefix="SET" suffixOverrides=",">
			wechat_openid = #{wechatOpenid},
			work_wechat_openid = #{workWechatOpenid},
			dingtalk_openid = #{dingtalkOpenid},
			wx_gzh_openid = #{wxGzhOpenid},
			wx_xcx_openid = #{wxXcxOpenid},
			feishu_open_id = #{feishuOpenId}
		</trim>
		where user_id = #{userId}
	</update>

	<select id="selectUserClientId" parameterType="Long" resultType="string">
		select u.client_id from sys_user u
		where u.user_id = #{userId}
	</select>

	<sql id="selectSysUserVo">
		select t.user_id,
			   t.user_name,
			   t.nick_name,
			   t.user_type,
			   t.email,
			   t.phonenumber,
			   t.sex,
			   t.avatar,
			   t.password,
			   t.status,
			   t.remark,
			   t.del_flag,
			   t.login_ip,
			   t.login_date,
			   t.client_id,
			   t.account_type,
			   t.vendor_sid,
			   t.customer_sid,
			   t.staff_sid,
			   t.telephone,
			   t.fax,
			   t.address,
			   t.ope_agent_id,
			   t.ope_agent_v_date_s,
			   t.ope_agent_v_date_e,
			   t.is_administrator,
			   t.dept_id,
			   t.wechat_openid,
			   t.work_wechat_openid,
			   t.dingtalk_openid,
			   t.feishu_open_id,
			   t.wx_gzh_openid,
			   t1.feishu_app_id,
			   t1.feishu_app_secret
		from sys_user t
				 LEFT JOIN s_sys_client t1 on t.client_id = t1.client_id
	</sql>

	<select id="selectSysUserById" parameterType="Long" resultMap="SysUserResult">
		<include refid="selectSysUserVo"/> where t.user_id = #{userId}
	</select>

	<select id="selectSysUserByName" parameterType="java.lang.String" resultMap="SysUserResult">
		<include refid="selectSysUserVo"/> where t.user_name = #{userName}
	</select>

	<select id="selectSysUserList" parameterType="com.platform.common.core.domain.entity.SysUser" resultMap="SysUserResult">
		<include refid="selectSysUserVo"/>
		<include refid="whereVo"/>
	</select>

	<select id="selectSysUserListAll" parameterType="com.platform.common.core.domain.entity.SysUser" resultMap="SysUserResult">
		<include refid="selectSysUserVo"/>
		<where>
			<if test="userIdList != null and userIdList.length >0 ">
				and t.user_id in
				(<foreach collection="userIdList" item="userId" separator=",">#{userId}</foreach>)
			</if>
			<if test="userName != null  and userName != ''">and t.user_name = #{userName}</if>
			<if test="nickName != null  and nickName != ''">and t.nick_name = #{nickName}</if>
			<if test="userType != null  and userType != ''">and t.user_type = #{userType}
			</if>
			<if test="email != null  and email != ''">and t.email = #{email}
			</if>
			<if test="phonenumber != null  and phonenumber != ''">and t.phonenumber = #{phonenumber}
			</if>
			<if test="sex != null  and sex != ''">and t.sex = #{sex}
			</if>
			<if test="avatar != null  and avatar != ''">and (
				<foreach collection="avatar.split(';')" item="item" separator="or">t.avatar like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="password != null  and password != ''">and (
				<foreach collection="password.split(';')" item="item" separator="or">t.password like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="status != null  and status != ''">and (
				<foreach collection="status.split(';')" item="item" separator="or">t.status like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="loginIp != null  and loginIp != ''">and (
				<foreach collection="loginIp.split(';')" item="item" separator="or">t.login_ip like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="loginDate != null ">and t.login_date = #{loginDate}</if>
			<if test="clientId != null  and clientId != ''">and t.client_id = #{clientId}
			</if>
			<if test="accountType != null  and accountType != ''">and t.account_type = #{accountType}
			</if>
			<if test="vendorSid != null ">and t.vendor_sid =#{vendorSid}</if>
			<if test="customerSid != null ">and t.customer_sid =#{customerSid}</if>
			<if test="staffSid != null ">and t.staff_sid =#{staffSid}</if>
			<if test="telephone != null  and telephone != ''">and t.telephone = #{telephone}
			</if>
			<if test="fax != null  and fax != ''">and (
				<foreach collection="fax.split(';')" item="item" separator="or">t.fax like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="address != null  and address != ''">and (
				<foreach collection="address.split(';')" item="item" separator="or">t.address like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="opeAgentId != null  and opeAgentId != ''">and (
				<foreach collection="opeAgentId.split(';')" item="item" separator="or">t.ope_agent_id like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="opeAgentVDateS != null ">and t.ope_agent_v_date_s = #{opeAgentVDateS}</if>
			<if test="opeAgentVDateE != null ">and t.ope_agent_v_date_e = #{opeAgentVDateE}</if>
			<if test="isAdministrator != null  and isAdministrator != ''">and (
				<foreach collection="isAdministrator.split(';')" item="item" separator="or">t.is_administrator like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="deptId != null ">and t.dept_id =#{deptId}</if>
			<if test="wechatOpenid != null  and wechatOpenid != ''">and (
				<foreach collection="wechatOpenid.split(';')" item="item" separator="or">t.wechat_openid like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="workWechatOpenid != null  and workWechatOpenid != ''">and (
				<foreach collection="workWechatOpenid.split(';')" item="item" separator="or">t.work_wechat_openid like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="dingtalkOpenid != null  and dingtalkOpenid != ''">and (
				<foreach collection="dingtalkOpenid.split(';')" item="item" separator="or">t.dingtalk_openid like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="params.dataScope != null and params.dataScope!=''">${params.dataScope}</if>
		</where>
	</select>

	<sql id="whereVo">
		<where>
			<if test="userIdList != null and userIdList.length >0 ">
				and t.user_id in
				(<foreach collection="userIdList" item="userId" separator=",">#{userId}</foreach>)
			</if>
			<if test="userName != null  and userName != ''">and t.user_name like concat('%', #{userName}, '%')</if>
			<if test="nickName != null  and nickName != ''">and t.nick_name like concat('%', #{nickName}, '%')</if>
			<if test="userType != null  and userType != ''">and (
				<foreach collection="userType.split(';')" item="item" separator="or">t.user_type like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="email != null  and email != ''">and (
				<foreach collection="email.split(';')" item="item" separator="or">t.email like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="phonenumber != null  and phonenumber != ''">and (
				<foreach collection="phonenumber.split(';')" item="item" separator="or">t.phonenumber like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="sex != null  and sex != ''">and (
				<foreach collection="sex.split(';')" item="item" separator="or">t.sex like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="avatar != null  and avatar != ''">and (
				<foreach collection="avatar.split(';')" item="item" separator="or">t.avatar like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="password != null  and password != ''">and (
				<foreach collection="password.split(';')" item="item" separator="or">t.password like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="status != null  and status != ''">and (
				<foreach collection="status.split(';')" item="item" separator="or">t.status like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="loginIp != null  and loginIp != ''">and (
				<foreach collection="loginIp.split(';')" item="item" separator="or">t.login_ip like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="loginDate != null ">and t.login_date = #{loginDate}</if>
			<if test="clientId != null  and clientId != ''">and (
				<foreach collection="clientId.split(';')" item="item" separator="or">t.client_id like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="accountType != null  and accountType != ''">and (
				<foreach collection="accountType.split(';')" item="item" separator="or">t.account_type like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="vendorSid != null ">and t.vendor_sid =#{vendorSid}</if>
			<if test="customerSid != null ">and t.customer_sid =#{customerSid}</if>
			<if test="staffSid != null ">and t.staff_sid =#{staffSid}</if>
			<if test="telephone != null  and telephone != ''">and (
				<foreach collection="telephone.split(';')" item="item" separator="or">t.telephone like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="fax != null  and fax != ''">and (
				<foreach collection="fax.split(';')" item="item" separator="or">t.fax like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="address != null  and address != ''">and (
				<foreach collection="address.split(';')" item="item" separator="or">t.address like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="opeAgentId != null  and opeAgentId != ''">and (
				<foreach collection="opeAgentId.split(';')" item="item" separator="or">t.ope_agent_id like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="opeAgentVDateS != null ">and t.ope_agent_v_date_s = #{opeAgentVDateS}</if>
			<if test="opeAgentVDateE != null ">and t.ope_agent_v_date_e = #{opeAgentVDateE}</if>
			<if test="isAdministrator != null  and isAdministrator != ''">and (
				<foreach collection="isAdministrator.split(';')" item="item" separator="or">t.is_administrator like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="deptId != null ">and t.dept_id =#{deptId}</if>
			<if test="wechatOpenid != null  and wechatOpenid != ''">and (
				<foreach collection="wechatOpenid.split(';')" item="item" separator="or">t.wechat_openid like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="workWechatOpenid != null  and workWechatOpenid != ''">and (
				<foreach collection="workWechatOpenid.split(';')" item="item" separator="or">t.work_wechat_openid like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="dingtalkOpenid != null  and dingtalkOpenid != ''">and (
				<foreach collection="dingtalkOpenid.split(';')" item="item" separator="or">t.dingtalk_openid like concat('%', #{item}, '%')</foreach>)
			</if>
			<if test="params.dataScope != null and params.dataScope!=''">${params.dataScope}</if>
		</where>
	</sql>

	<select id="selectSysUserRoleList" parameterType="com.platform.common.core.domain.entity.SysUser" resultMap="SysUserResult">
		select t.* from sys_user_role t
		left join sys_user t1 on t.user_id = t1.user_id
		left join sys_role t2 on t.role_id = t2.role_id
		<where>
			<if test="clientId != null and clientId != ''">
				and t.client_id = #{clientId}
			</if>
			<if test="userId != null">
				and t.user_id = #{userId}
			</if>
			<if test="roleId != null">
				and t.role_id = #{roleId}
			</if>
			<if test="roleName != null and roleName != ''">
				and t2.role_name = #{roleName}
			</if>
		</where>
	</select>

	<!--添加多个-->
	<insert id="inserts">insert into sys_user
		<trim prefix="(" suffix=")" suffixOverrides=",">user_name, nick_name, user_type, email, phonenumber, sex, avatar, password, status, del_flag, login_ip, login_date, create_by, create_time, update_by, update_time, remark, client_id, account_type, vendor_sid, customer_sid, staff_sid, telephone, fax, address, ope_agent_id, ope_agent_v_date_s, ope_agent_v_date_e, is_administrator, dept_id, wechat_openid, work_wechat_openid, dingtalk_openid,</trim> values
		<foreach collection="list" item="item" separator=",">
			<trim prefix=" (" suffix=")" suffixOverrides=",">#{item.userName}, #{item.nickName}, #{item.userType}, #{item.email}, #{item.phonenumber}, #{item.sex}, #{item.avatar}, #{item.password}, #{item.status}, #{item.delFlag}, #{item.loginIp}, #{item.loginDate}, #{item.createBy}, #{item.createTime}, #{item.updateBy}, #{item.updateTime}, #{item.remark}, #{item.clientId}, #{item.accountType}, #{item.vendorSid}, #{item.customerSid}, #{item.staffSid}, #{item.telephone}, #{item.fax}, #{item.address}, #{item.opeAgentId}, #{item.opeAgentVDateS}, #{item.opeAgentVDateE}, #{item.isAdministrator}, #{item.deptId}, #{item.wechatOpenid}, #{item.workWechatOpenid}, #{item.dingtalkOpenid},</trim>
		</foreach>
	</insert>

	<!--更新-->
	<update id="updateAllById">update sys_user
		<trim prefix="SET" suffixOverrides=",">user_id = #{userId}, user_name = #{userName}, nick_name = #{nickName}, user_type = #{userType}, email = #{email}, phonenumber = #{phonenumber}, sex = #{sex}, avatar = #{avatar}, password = #{password}, status = #{status}, del_flag = #{delFlag}, login_ip = #{loginIp}, login_date = #{loginDate}, create_by = #{createBy}, create_time = #{createTime}, update_by = #{updateBy}, update_time = #{updateTime}, remark = #{remark}, client_id = #{clientId}, account_type = #{accountType}, vendor_sid = #{vendorSid}, customer_sid = #{customerSid}, staff_sid = #{staffSid}, telephone = #{telephone}, fax = #{fax}, address = #{address}, ope_agent_id = #{opeAgentId}, ope_agent_v_date_s = #{opeAgentVDateS}, ope_agent_v_date_e = #{opeAgentVDateE}, is_administrator = #{isAdministrator}, dept_id = #{deptId}, wechat_openid = #{wechatOpenid}, work_wechat_openid = #{workWechatOpenid}, dingtalk_openid = #{dingtalkOpenid},</trim> where user_id = #{userId}
	</update>

	<!--更新多个-->
	<update id="updatesAllById">
		<foreach collection="list" item="o" separator=";">update sys_user
			<trim prefix="SET" suffixOverrides=",">user_id = #{userId}, user_name = #{userName}, nick_name = #{nickName}, user_type = #{userType}, email = #{email}, phonenumber = #{phonenumber}, sex = #{sex}, avatar = #{avatar}, password = #{password}, status = #{status}, del_flag = #{delFlag}, login_ip = #{loginIp}, login_date = #{loginDate}, create_by = #{createBy}, create_time = #{createTime}, update_by = #{updateBy}, update_time = #{updateTime}, remark = #{remark}, client_id = #{clientId}, account_type = #{accountType}, vendor_sid = #{vendorSid}, customer_sid = #{customerSid}, staff_sid = #{staffSid}, telephone = #{telephone}, fax = #{fax}, address = #{address}, ope_agent_id = #{opeAgentId}, ope_agent_v_date_s = #{opeAgentVDateS}, ope_agent_v_date_e = #{opeAgentVDateE}, is_administrator = #{isAdministrator}, dept_id = #{deptId}, wechat_openid = #{wechatOpenid}, work_wechat_openid = #{workWechatOpenid}, dingtalk_openid = #{dingtalkOpenid},</trim> where user_id = #{userId}
		</foreach>
	</update>

	<select id="selectUserByPositionStaff" parameterType="com.platform.common.core.domain.entity.SysUser" resultMap="SysUserResult">
		select t.user_id,
		t.user_name,
		t.nick_name,
		t.user_type,
		t2.position_sid
		from sys_user t
		left join s_bas_staff t1 on t.staff_sid = t1.staff_sid
		left join s_bas_position t2 on t1.default_position = t2.position_sid
		<where>
			and t.status = '0'
			<if test="positionSidList != null and positionSidList.length >0 ">
				and t2.position_sid in
				(<foreach collection="positionSidList" item="positionSid" separator=",">#{positionSid}</foreach>)
			</if>
		</where>
	</select>

	<update id="updateByInfoId">
		update sys_user
		<trim prefix="SET" suffixOverrides=",">
			nick_name = #{nickName},
			user_type = #{userType},
			account_type = #{accountType},
			vendor_sid = #{vendorSid},
			customer_sid = #{customerSid},
			staff_sid = #{staffSid},
			email = #{email},
			fax = #{fax},
			phonenumber = #{phonenumber},
			telephone = #{telephone},
			sex = #{sex},
			avatar = #{avatar},
			address = #{address},
			status = #{status},
			update_by = #{updateBy},
			update_time = #{updateTime},
			remark = #{remark},
		</trim>
		where user_id = #{userId}
	</update>

	<insert id="insertInfomation" parameterType="com.platform.common.core.domain.entity.SysUser">
		insert into sys_user
		<trim prefix="(" suffix=")" suffixOverrides=",">
			user_name, nick_name, user_type, email, phonenumber, sex, avatar, password, status, del_flag,
			create_by, create_time, remark, client_id, account_type, vendor_sid,
			customer_sid, staff_sid, telephone, fax, address, is_administrator,
		</trim>
		values
		<trim prefix=" (" suffix=")" suffixOverrides=",">
			#{userName}, #{nickName}, #{userType}, #{email}, #{phonenumber}, #{sex},
			#{avatar}, #{password}, #{status}, #{delFlag},
			#{createBy}, #{createTime}, #{remark}, #{clientId},
			#{accountType}, #{vendorSid}, #{customerSid}, #{staffSid}, #{telephone}, #{fax},
			#{address}, #{isAdministrator},
		</trim>
	</insert>

	<select id="selectStaffById" parameterType="Long" resultMap="SysUserResult">
		select mobphone as phonenumber, email_personal as email
		from s_bas_staff
		where staff_sid = #{staffSid}
	</select>




</mapper>
