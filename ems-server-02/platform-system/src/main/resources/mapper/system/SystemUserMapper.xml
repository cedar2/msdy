<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.platform.system.mapper.SystemUserMapper">
    <resultMap type="com.platform.common.core.domain.entity.SysUser" id="SysUserResult">
        <result property="userId" column="user_id"/>
        <result property="userName" column="user_name"/>
        <result property="nickName" column="nick_name"/>
        <result property="userType" column="user_type"/>
        <result property="email" column="email"/>
        <result property="phonenumber" column="phonenumber"/>
        <result property="sex" column="sex"/>
        <result property="avatar" column="avatar"/>
        <result property="password" column="password"/>
        <result property="status" column="status"/>
        <result property="delFlag" column="del_flag"/>
        <result property="loginIp" column="login_ip"/>
        <result property="loginDate" column="login_date"/>
        <result property="clientId" column="client_id"/>
        <result property="accountType" column="account_type"/>
        <result property="vendorSid" column="vendor_sid"/>
        <result property="customerSid" column="customer_sid"/>
        <result property="staffSid" column="staff_sid"/>
        <result property="telephone" column="telephone"/>
        <result property="fax" column="fax"/>
        <result property="address" column="address"/>
        <result property="opeAgentId" column="ope_agent_id"/>
        <result property="opeAgentVDateS" column="ope_agent_v_date_s"/>
        <result property="opeAgentVDateE" column="ope_agent_v_date_e"/>
        <result property="isAdministrator" column="is_administrator"/>
        <result property="deptId" column="dept_id"/>
        <result property="wechatOpenid" column="wechat_openid"/>
        <result property="roleId" column="role_id"/>
        <result property="roleName" column="role_name"/>
        <result property="workWechatOpenid" column="work_wechat_openid"/>
        <result property="dingtalkOpenid" column="dingtalk_openid"/>
        <result property="feishuOpenId" column="feishu_open_id"/>
        <result property="wxGzhOpenid" column="wx_gzh_openid"/>
        <result property="jiandaoyunUsername" column="jiandaoyun_username"/>
    </resultMap>
    <sql id="selectSysUserVo">
        select t.user_id,
               t.user_name,
               t.nick_name,
               t.user_type,
               t.email,
               t.phonenumber,
               t.sex,
               t.avatar,
               t.password,
               t.status,
               t.remark,
               t.del_flag,
               t.login_ip,
               t.login_date,
               t.client_id,
               t.account_type,
               t.vendor_sid,
               t.customer_sid,
               t.staff_sid,
               t.telephone,
               t.fax,
               t.address,
               t.ope_agent_id,
               t.ope_agent_v_date_s,
               t.ope_agent_v_date_e,
               t.is_administrator,
               t.dept_id,
               t.wechat_openid,
               t.work_wechat_openid,
               t.dingtalk_openid,
               t.feishu_open_id,
               t.wx_gzh_openid,
               t1.feishu_app_id,
               t1.feishu_app_secret
        from sys_user t
                 LEFT JOIN s_sys_client t1 on t.client_id = t1.client_id
    </sql>
    <select id="selectSysUserById" parameterType="Long" resultMap="SysUserResult">
        <include refid="selectSysUserVo"/> where t.user_id = #{userId}
    </select>
    <select id="selectSysUserByName" parameterType="java.lang.String" resultMap="SysUserResult">
        <include refid="selectSysUserVo"/> where t.user_name = #{userName}
    </select>
    <select id="selectSysUserList" parameterType="com.platform.common.core.domain.entity.SysUser" resultMap="SysUserResult">
        <include refid="selectSysUserVo"/>
        <include refid="whereVo"/>
    </select>
    <select id="selectSysUserListAll" parameterType="com.platform.common.core.domain.entity.SysUser" resultMap="SysUserResult">
        <include refid="selectSysUserVo"/>
        <where>
            <if test="userIdList != null and userIdList.length >0 ">
                and t.user_id in
                (<foreach collection="userIdList" item="userId" separator=",">#{userId}</foreach>)
            </if>
            <if test="userName != null  and userName != ''">and t.user_name = #{userName}</if>
            <if test="nickName != null  and nickName != ''">and t.nick_name = #{nickName}</if>
            <if test="userType != null  and userType != ''">and t.user_type = #{userType}
            </if>
            <if test="email != null  and email != ''">and t.email = #{email}
            </if>
            <if test="phonenumber != null  and phonenumber != ''">and t.phonenumber = #{phonenumber}
            </if>
            <if test="sex != null  and sex != ''">and t.sex = #{sex}
            </if>
            <if test="avatar != null  and avatar != ''">and (
                <foreach collection="avatar.split(';')" item="item" separator="or">t.avatar like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="password != null  and password != ''">and (
                <foreach collection="password.split(';')" item="item" separator="or">t.password like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="status != null  and status != ''">and (
                <foreach collection="status.split(';')" item="item" separator="or">t.status like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="loginIp != null  and loginIp != ''">and (
                <foreach collection="loginIp.split(';')" item="item" separator="or">t.login_ip like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="loginDate != null ">and t.login_date = #{loginDate}</if>
            <if test="clientId != null  and clientId != ''">and t.client_id = #{clientId}
            </if>
            <if test="accountType != null  and accountType != ''">and t.account_type = #{accountType}
            </if>
            <if test="vendorSid != null ">and t.vendor_sid =#{vendorSid}</if>
            <if test="customerSid != null ">and t.customer_sid =#{customerSid}</if>
            <if test="staffSid != null ">and t.staff_sid =#{staffSid}</if>
            <if test="telephone != null  and telephone != ''">and t.telephone = #{telephone}
            </if>
            <if test="fax != null  and fax != ''">and (
                <foreach collection="fax.split(';')" item="item" separator="or">t.fax like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="address != null  and address != ''">and (
                <foreach collection="address.split(';')" item="item" separator="or">t.address like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="opeAgentId != null  and opeAgentId != ''">and (
                <foreach collection="opeAgentId.split(';')" item="item" separator="or">t.ope_agent_id like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="opeAgentVDateS != null ">and t.ope_agent_v_date_s = #{opeAgentVDateS}</if>
            <if test="opeAgentVDateE != null ">and t.ope_agent_v_date_e = #{opeAgentVDateE}</if>
            <if test="isAdministrator != null  and isAdministrator != ''">and (
                <foreach collection="isAdministrator.split(';')" item="item" separator="or">t.is_administrator like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="deptId != null ">and t.dept_id =#{deptId}</if>
            <if test="wechatOpenid != null  and wechatOpenid != ''">and (
                <foreach collection="wechatOpenid.split(';')" item="item" separator="or">t.wechat_openid like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="workWechatOpenid != null  and workWechatOpenid != ''">and (
                <foreach collection="workWechatOpenid.split(';')" item="item" separator="or">t.work_wechat_openid like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="dingtalkOpenid != null  and dingtalkOpenid != ''">and (
                <foreach collection="dingtalkOpenid.split(';')" item="item" separator="or">t.dingtalk_openid like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="params.dataScope != null and params.dataScope!=''">${params.dataScope}</if>
        </where>
    </select>
    <sql id="whereVo">
        <where>
            <if test="userIdList != null and userIdList.length >0 ">
                and t.user_id in
                (<foreach collection="userIdList" item="userId" separator=",">#{userId}</foreach>)
            </if>
            <if test="userName != null  and userName != ''">and t.user_name like concat('%', #{userName}, '%')</if>
            <if test="nickName != null  and nickName != ''">and t.nick_name like concat('%', #{nickName}, '%')</if>
            <if test="userType != null  and userType != ''">and (
                <foreach collection="userType.split(';')" item="item" separator="or">t.user_type like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="email != null  and email != ''">and (
                <foreach collection="email.split(';')" item="item" separator="or">t.email like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="phonenumber != null  and phonenumber != ''">and (
                <foreach collection="phonenumber.split(';')" item="item" separator="or">t.phonenumber like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="sex != null  and sex != ''">and (
                <foreach collection="sex.split(';')" item="item" separator="or">t.sex like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="avatar != null  and avatar != ''">and (
                <foreach collection="avatar.split(';')" item="item" separator="or">t.avatar like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="password != null  and password != ''">and (
                <foreach collection="password.split(';')" item="item" separator="or">t.password like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="status != null  and status != ''">and (
                <foreach collection="status.split(';')" item="item" separator="or">t.status like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="loginIp != null  and loginIp != ''">and (
                <foreach collection="loginIp.split(';')" item="item" separator="or">t.login_ip like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="loginDate != null ">and t.login_date = #{loginDate}</if>
            <if test="clientId != null  and clientId != ''">and (
                <foreach collection="clientId.split(';')" item="item" separator="or">t.client_id like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="accountType != null  and accountType != ''">and (
                <foreach collection="accountType.split(';')" item="item" separator="or">t.account_type like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="vendorSid != null ">and t.vendor_sid =#{vendorSid}</if>
            <if test="customerSid != null ">and t.customer_sid =#{customerSid}</if>
            <if test="staffSid != null ">and t.staff_sid =#{staffSid}</if>
            <if test="telephone != null  and telephone != ''">and (
                <foreach collection="telephone.split(';')" item="item" separator="or">t.telephone like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="fax != null  and fax != ''">and (
                <foreach collection="fax.split(';')" item="item" separator="or">t.fax like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="address != null  and address != ''">and (
                <foreach collection="address.split(';')" item="item" separator="or">t.address like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="opeAgentId != null  and opeAgentId != ''">and (
                <foreach collection="opeAgentId.split(';')" item="item" separator="or">t.ope_agent_id like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="opeAgentVDateS != null ">and t.ope_agent_v_date_s = #{opeAgentVDateS}</if>
            <if test="opeAgentVDateE != null ">and t.ope_agent_v_date_e = #{opeAgentVDateE}</if>
            <if test="isAdministrator != null  and isAdministrator != ''">and (
                <foreach collection="isAdministrator.split(';')" item="item" separator="or">t.is_administrator like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="deptId != null ">and t.dept_id =#{deptId}</if>
            <if test="wechatOpenid != null  and wechatOpenid != ''">and (
                <foreach collection="wechatOpenid.split(';')" item="item" separator="or">t.wechat_openid like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="workWechatOpenid != null  and workWechatOpenid != ''">and (
                <foreach collection="workWechatOpenid.split(';')" item="item" separator="or">t.work_wechat_openid like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="dingtalkOpenid != null  and dingtalkOpenid != ''">and (
                <foreach collection="dingtalkOpenid.split(';')" item="item" separator="or">t.dingtalk_openid like concat('%', #{item}, '%')</foreach>)
            </if>
            <if test="params.dataScope != null and params.dataScope!=''">${params.dataScope}</if>
        </where>
    </sql>
    <select id="selectSysUserRoleList" parameterType="com.platform.common.core.domain.entity.SysUser" resultMap="SysUserResult">
        select t.* from sys_user_role t
        left join sys_user t1 on t.user_id = t1.user_id
        left join sys_role t2 on t.role_id = t2.role_id
        <where>
            <if test="clientId != null and clientId != ''">
                and t.client_id = #{clientId}
            </if>
            <if test="userId != null">
                and t.user_id = #{userId}
            </if>
            <if test="roleId != null">
                and t.role_id = #{roleId}
            </if>
            <if test="roleName != null and roleName != ''">
                and t2.role_name = #{roleName}
            </if>
        </where>
    </select>
    <!--添加多个-->
    <insert id="inserts">insert into sys_user
        <trim prefix="(" suffix=")" suffixOverrides=",">user_name, nick_name, user_type, email, phonenumber, sex, avatar, password, status, del_flag, login_ip, login_date, create_by, create_time, update_by, update_time, remark, client_id, account_type, vendor_sid, customer_sid, staff_sid, telephone, fax, address, ope_agent_id, ope_agent_v_date_s, ope_agent_v_date_e, is_administrator, dept_id, wechat_openid, work_wechat_openid, dingtalk_openid,</trim> values
        <foreach collection="list" item="item" separator=",">
            <trim prefix=" (" suffix=")" suffixOverrides=",">#{item.userName}, #{item.nickName}, #{item.userType}, #{item.email}, #{item.phonenumber}, #{item.sex}, #{item.avatar}, #{item.password}, #{item.status}, #{item.delFlag}, #{item.loginIp}, #{item.loginDate}, #{item.createBy}, #{item.createTime}, #{item.updateBy}, #{item.updateTime}, #{item.remark}, #{item.clientId}, #{item.accountType}, #{item.vendorSid}, #{item.customerSid}, #{item.staffSid}, #{item.telephone}, #{item.fax}, #{item.address}, #{item.opeAgentId}, #{item.opeAgentVDateS}, #{item.opeAgentVDateE}, #{item.isAdministrator}, #{item.deptId}, #{item.wechatOpenid}, #{item.workWechatOpenid}, #{item.dingtalkOpenid},</trim>
        </foreach>
    </insert>
    <!--更新-->
    <update id="updateAllById">update sys_user
        <trim prefix="SET" suffixOverrides=",">user_id = #{userId}, user_name = #{userName}, nick_name = #{nickName}, user_type = #{userType}, email = #{email}, phonenumber = #{phonenumber}, sex = #{sex}, avatar = #{avatar}, password = #{password}, status = #{status}, del_flag = #{delFlag}, login_ip = #{loginIp}, login_date = #{loginDate}, create_by = #{createBy}, create_time = #{createTime}, update_by = #{updateBy}, update_time = #{updateTime}, remark = #{remark}, client_id = #{clientId}, account_type = #{accountType}, vendor_sid = #{vendorSid}, customer_sid = #{customerSid}, staff_sid = #{staffSid}, telephone = #{telephone}, fax = #{fax}, address = #{address}, ope_agent_id = #{opeAgentId}, ope_agent_v_date_s = #{opeAgentVDateS}, ope_agent_v_date_e = #{opeAgentVDateE}, is_administrator = #{isAdministrator}, dept_id = #{deptId}, wechat_openid = #{wechatOpenid}, work_wechat_openid = #{workWechatOpenid}, dingtalk_openid = #{dingtalkOpenid},</trim> where user_id = #{userId}
    </update>
    <!--更新多个-->
    <update id="updatesAllById">
        <foreach collection="list" item="o" separator=";">update sys_user
            <trim prefix="SET" suffixOverrides=",">user_id = #{userId}, user_name = #{userName}, nick_name = #{nickName}, user_type = #{userType}, email = #{email}, phonenumber = #{phonenumber}, sex = #{sex}, avatar = #{avatar}, password = #{password}, status = #{status}, del_flag = #{delFlag}, login_ip = #{loginIp}, login_date = #{loginDate}, create_by = #{createBy}, create_time = #{createTime}, update_by = #{updateBy}, update_time = #{updateTime}, remark = #{remark}, client_id = #{clientId}, account_type = #{accountType}, vendor_sid = #{vendorSid}, customer_sid = #{customerSid}, staff_sid = #{staffSid}, telephone = #{telephone}, fax = #{fax}, address = #{address}, ope_agent_id = #{opeAgentId}, ope_agent_v_date_s = #{opeAgentVDateS}, ope_agent_v_date_e = #{opeAgentVDateE}, is_administrator = #{isAdministrator}, dept_id = #{deptId}, wechat_openid = #{wechatOpenid}, work_wechat_openid = #{workWechatOpenid}, dingtalk_openid = #{dingtalkOpenid},</trim> where user_id = #{userId}
        </foreach>
    </update>
    <select id="selectUserByNameAndId" resultMap="SysUserResult">
        <include refid="selectSysUserVo"/>
        where t.user_name = #{userName} and t.client_id=#{clientId}
    </select>

    <select id="selectUserByPositionStaff" parameterType="com.platform.common.core.domain.entity.SysUser" resultMap="SysUserResult">
        select t.user_id,
        t.user_name,
        t.nick_name,
        t.user_type,
        t2.position_sid
        from sys_user t
        left join s_bas_staff t1 on t.staff_sid = t1.staff_sid
        left join s_bas_position t2 on t1.default_position = t2.position_sid
        <where>
            and t.status = '0'
            <if test="positionSidList != null and positionSidList.length >0 ">
                and t2.position_sid in
                (<foreach collection="positionSidList" item="positionSid" separator=",">#{positionSid}</foreach>)
            </if>
        </where>
    </select>

    <update id="updateByInfoId">
        update sys_user
        <trim prefix="SET" suffixOverrides=",">
            nick_name = #{nickName},
            user_type = #{userType},
            account_type = #{accountType},
            vendor_sid = #{vendorSid},
            customer_sid = #{customerSid},
            staff_sid = #{staffSid},
            email = #{email},
            fax = #{fax},
            phonenumber = #{phonenumber},
            telephone = #{telephone},
            sex = #{sex},
            avatar = #{avatar},
            address = #{address},
            status = #{status},
            update_by = #{updateBy},
            update_time = #{updateTime},
            remark = #{remark},
        </trim>
        where user_id = #{userId}
    </update>

    <insert id="insertInfomation" parameterType="com.platform.common.core.domain.entity.SysUser">
        insert into sys_user
        <trim prefix="(" suffix=")" suffixOverrides=",">
            user_name, nick_name, user_type, email, phonenumber, sex, avatar, password, status, del_flag,
            create_by, create_time, remark, client_id, account_type, vendor_sid,
            customer_sid, staff_sid, telephone, fax, address, is_administrator,
        </trim>
        values
        <trim prefix=" (" suffix=")" suffixOverrides=",">
            #{userName}, #{nickName}, #{userType}, #{email}, #{phonenumber}, #{sex},
            #{avatar}, #{password}, #{status}, #{delFlag},
            #{createBy}, #{createTime}, #{remark}, #{clientId},
            #{accountType}, #{vendorSid}, #{customerSid}, #{staffSid}, #{telephone}, #{fax},
            #{address}, #{isAdministrator},
        </trim>
    </insert>


    <select id="selectStaffById" parameterType="Long" resultMap="SysUserResult">
        select mobphone as phonenumber, email_personal as email
        from s_bas_staff
        where staff_sid = #{staffSid}
    </select>

</mapper>
